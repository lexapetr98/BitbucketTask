define("bitbucket/internal/util/feature-loader","module exports @atlassian/aui jquery lodash require bitbucket/internal/util/events".split(" "),function(r,l,t,F,G,H,I){function y(b,c){if("function"!==typeof b.load||"function"!==typeof b.unload)throw Error("Modules require both a load and unload callback. Please use:\n"+z(c));}function z(b){return"FeatureLoader.registerHandler('"+b+"', /urlMatcher/, {\n    load : loadFn,\n    unload : unloadFn,\n    keyboardShortcutContexts : [ 'commit', ... ]});"}
function k(h){function l(a){function f(){g.default.trigger(h.unloadedEvent,null,a)}if(!b.default.includes(e,a))return c.default.Deferred().resolve();var d=a.module.unload(m);e=b.default.without(e,a);if(d&&d.then)return d.then(f);f();return c.default.Deferred().resolve()}function A(a){function f(){g.default.trigger(h.loadedEvent,null,a)}if(b.default.includes(e,a))return c.default.Deferred().resolve();a.module||(a.module=(0,J.default)(a.moduleName),y(a.module,a.name));var d=a.module.load(m,u);e.push(a);
if(d&&d.then)return d.then(f);f();return c.default.Deferred().resolve()}function B(){if(!n||v!==window.location.href){v=window.location.href;var a=w(v);a.length?(b.default.forEach(a,function(a){g.default.trigger(h.requestedEvent,null,a.name)}),p||(p=!0,C.then(r))):n?window.location.reload():g.default.trigger(h.errorEvent,null,{message:K.default.I18n.getText("bitbucket.web.featureloader.nohandler"),code:k.NO_HANDLER})}}function r(){p=!1;var a=w(window.location.href),f=b.default.difference(a,e);a=b.default.difference(e,
a);if(f.length||a.length)e.length?a=c.default.when.apply(c.default,b.default.map(a,l)):((0,c.default)(m).empty(),a=c.default.Deferred().resolve()),C=a.then(function(){return c.default.when.apply(c.default,b.default.map(f,A))}).then(function(){x&&x.resetContexts()})}function w(a){return b.default.filter(q,function(b){return b.urlRegex&&b.urlRegex.test(a)})}function D(){B()}function t(a){return a.module&&a.module.keyboardShortcutContexts||[]}function E(a){var c=b.default.chain(e).flatMap(t).uniq().value();
b.default.forEach(c,function(b){a.enableContext(b)})}if(!(this instanceof k))return new k(h);h=c.default.extend({},k.defaults,h);var v=window.location.href,e=[],q={},C=c.default.Deferred().resolve(),p,n=!1,m,x,u={};this.registerHandler=function(a,c,d){if(b.default.has(q,a))throw Error("A handler with the name '"+a+"' already exists.");if(!d)throw Error("No module or module name was provided. Please use:\n"+z(a));"string"===typeof d?a=q[a]={name:a,urlRegex:c,moduleName:d}:(y(d,a),a=q[a]={name:a,urlRegex:c,
module:d});n&&!p&&b.default.includes(w(window.location.href),a)&&A(a);return this};this.setElement=function(a){m=a};this.setContext=function(a){u=babelHelpers.extends({},u,a)};this.setKeyboardShortcuts=function(a){x=a};this.current=function(){return e.slice()};this.init=function(a){m=a;B();g.default.on("bitbucket.internal.history.changestate",D);g.default.on("bitbucket.internal.widget.keyboard-shortcuts.register-contexts",E);n=!0};this.destroy=function(){g.default.off("bitbucket.internal.history.changestate",
D);g.default.off("bitbucket.internal.widget.keyboard-shortcuts.register-contexts",E)};return this}Object.defineProperty(l,"__esModule",{value:!0});var K=babelHelpers.interopRequireDefault(t),c=babelHelpers.interopRequireDefault(F),b=babelHelpers.interopRequireDefault(G),J=babelHelpers.interopRequireDefault(H),g=babelHelpers.interopRequireDefault(I);k.defaults={unloadedEvent:"stash.util.feature-loader.unloaded",loadedEvent:"stash.util.feature-loader.loaded",requestedEvent:"stash.util.feature-loader.loadRequested",
errorEvent:"stash.util.feature-loader.errorOccurred"};k.NO_HANDLER="NO_HANDLER";l.default=k;r.exports=l["default"]});