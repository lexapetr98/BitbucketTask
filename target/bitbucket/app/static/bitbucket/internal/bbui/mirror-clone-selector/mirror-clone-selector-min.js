define("bitbucket/internal/bbui/mirror-clone-selector/mirror-clone-selector",["module","exports","jquery","lodash","../widget/widget"],function(l,h,f,m,n){Object.defineProperty(h,"__esModule",{value:!0});var c=babelHelpers.interopRequireDefault(f),e=babelHelpers.interopRequireDefault(m);f=function(f){function g(a,b){babelHelpers.classCallCheck(this,g);b=babelHelpers.possibleConstructorReturn(this,(g.__proto__||Object.getPrototypeOf(g)).call(this,b));b.$el=(0,c.default)(a);b.availableMirrors=[];b.clicked=
!1;b.loaded=!1;b.preferredMirrorId=b.options.preferredMirrorId;b.cloneProtocol=b.options.cloneProtocol;b.init();return b}babelHelpers.inherits(g,f);babelHelpers.createClass(g,[{key:"addMirror",value:function(a){if(a.available){this.availableMirrors.push(a);var b=(0,c.default)("#available-mirror-list"),d=b.find("li.mirror"),k=(0,c.default)(bitbucket.internal.component.mirroringCloneSelector.mirrorItem({item:a,extraClasses:"mirror"}));(d=e.default.find(d,function(b){return(0,c.default)(b).text().trim()>
a.mirrorName}))?k.insertBefore(d):k.appendTo(b);this.$trigger.removeAttr("disabled");this.preferredMirrorId!==a.id||this.clicked||this.selectMirror(a.id)}}},{key:"getCloneUrl",value:function(a){return e.default.get(e.default.find(a.links.clone,{name:this.getProtocol()}),"href","")}},{key:"getProtocol",value:function(){return this.cloneProtocol}},{key:"hideDropdown",value:function(){this.$dropdown.is(":visible")&&this.$trigger.trigger("aui-button-invoke")}},{key:"init",value:function(){this.$el.html(bitbucket.internal.component.mirroringCloneSelector.main({primary:this.options.primary}));
this.$trigger=this.$el.find("#available-mirrors-trigger");this.$trigger.on("click",function(a){return a.preventDefault()});this.initDropdown()}},{key:"initDropdown",value:function(){var a=this;this.$dropdown=(0,c.default)("#available-mirrors");this.$dropdown.on("click",".mirror-item",function(b){b.preventDefault();a.selectMirror((0,c.default)(b.currentTarget).data("id"));a._updatePreferredMirror();a.clicked=!0})}},{key:"load",value:function(){var a=this;this.loaded||(this.loaded=!0,this.options.getMirrors().done(function(b){var d=
[];a.preferredMirrorId&&(d=e.default.remove(b,function(b){return b.id===a.preferredMirrorId}));d.forEach(function(b){a.loadMirror(b)});b.forEach(function(b){a.loadMirror(b)})}))}},{key:"loadMirror",value:function(a){var b=this;c.default.ajax({type:"GET",contentType:"application/json",url:a.url,dataType:"json"}).done(function(d){d.id=a.id;b.addMirror(d)})}},{key:"selectMirror",value:function(a){this.currentMirrorId=a;this.updateCloneUrl()}},{key:"showSetPushUpstream",value:function(a){var b=(0,c.default)("#update-push-url-container");
a?((0,c.default)("#update-push-url-input").val("git remote set-url --push origin "+this.getCloneUrl(this.options.primary)),b.removeClass("hidden")):b.addClass("hidden")}},{key:"updateCloneProtocol",value:function(a){this.cloneProtocol=a;this.updateCloneUrl();return a}},{key:"canWriteTo",value:function(a,b){return b.links.push&&b.links.push.some(function(b){return b.name===a})}},{key:"updateCloneUrl",value:function(){if(this.currentMirrorId){var a=e.default.find(this.availableMirrors,{id:this.currentMirrorId});
this.showSetPushUpstream(!this.canWriteTo(this.cloneProtocol,a))}else a=this.options.primary,this.showSetPushUpstream(!1);this.currentMirrorId=a.id;this.$trigger.text(a.mirrorName);this.$trigger.css("maxWidth",this.$el.width()-this.$el.find("#clone-from-label").width()-15);this.options.updateCloneUrl(this.getProtocol(),this.getCloneUrl(a))}},{key:"show",value:function(){this.$el.show()}},{key:"hide",value:function(){this.hideDropdown();this.$el.hide()}},{key:"_updatePreferredMirror",value:function(){this.preferredMirrorId=
this.currentMirrorId;this.options.updatePreferredMirror(this.preferredMirrorId)}}]);return g}(babelHelpers.interopRequireDefault(n).default);h.default=f;f.defaults={cloneProtocol:"http",preferredMirrorId:null,updateCloneUrl:e.default.noop,updatePreferredMirror:e.default.noop,getMirrors:function(){return c.default.when([])}};l.exports=h["default"]});