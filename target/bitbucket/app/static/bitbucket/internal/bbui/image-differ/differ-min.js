define("bitbucket/internal/bbui/image-differ/differ","module exports jquery lodash resemblejs ../widget/widget ./image-differ-mode ./image-differ-modes".split(" "),function(t,m,n,u,v,w,p,x){function h(d){var c=(0,e.default)(d);if(c.data("natural-size"))return e.default.Deferred().resolve(c.data("natural-size"));if(d.naturalWidth)return d={width:d.naturalWidth,height:d.naturalHeight},c.data("natural-size",d),e.default.Deferred().resolve(d);var a=new Image,b=e.default.Deferred();d=g.default.once(function(){var d=
{width:a.width,height:a.height};c.data("natural-size",d);b.resolve(d)});a.onload=d;a.src=c.attr("src");a.complete&&d();return b}function k(d,c){var a=d.data("margin_border_padding");null==a&&(a=d.outerWidth(!0)-d.width(),d.data("margin_border_padding",a));return c-a}function q(d){var c=document.createElement("canvas"),a=c.getContext("2d");return h(d).then(function(b){c.height=b.height;c.width=b.width;a.drawImage(d[0],0,0);return a.getImageData(0,0,c.width,c.height)})}Object.defineProperty(m,"__esModule",
{value:!0});var e=babelHelpers.interopRequireDefault(n),g=babelHelpers.interopRequireDefault(u),r=babelHelpers.interopRequireDefault(v);n=babelHelpers.interopRequireDefault(w);var l=babelHelpers.interopRequireDefault(p),f=babelHelpers.interopRequireDefault(x);p=function(d){function c(a){babelHelpers.classCallCheck(this,c);var b=babelHelpers.possibleConstructorReturn(this,(c.__proto__||Object.getPrototypeOf(c)).call(this));b._$container=(0,e.default)(a);return b}babelHelpers.inherits(c,d);babelHelpers.createClass(c,
[{key:"init",value:function(){var a=this,b=this._$imgs=this._$container.find("img");this._$sinceImg=b.eq(0);this._$untilImg=b.eq(1);this._$untilRevision=this._$untilImg.parent();this._$sinceRevision=this._$sinceImg.parent();this._$revisions=this._$untilRevision.add(this._$sinceRevision);this._$untilRevisionLabel=this._$untilRevision.find("h5");this._$sinceRevisionLabel=this._$sinceRevision.find("h5");this._setupDiffModes();this.setMode(f.default.TWO_UP);var d=e.default.Deferred(),c=[f.default.TWO_UP],
y=g.default.chain(f.default).values().difference(c).value();e.default.when(h(this._$sinceImg),h(this._$untilImg)).done(function(b,e){a.enabledModes=b.width===e.width&&b.height===e.height&&0<b.width?c.concat(y):c;d.resolve(a.enabledModes)}).fail(function(){d.reject()});return d}},{key:"destroy",value:function(){this.modes&&this._mode&&this.modes[this._mode].destroy();this._mode=null}},{key:"setMode",value:function(a){this._mode!==a&&(this._onDiffModeChanged(a,this._mode),this._mode=a)}},{key:"_onDiffModeChanged",
value:function(a,b){this._$container.removeClass(g.default.values(f.default).join(" ")).addClass(a);b&&this.modes[b].destroy();a&&this.modes[a].setup();this.trigger("modeChanged",{newMode:a,oldMode:b})}},{key:"_setupDiffModes",value:function(){var a=this;this.modes={};this.modes[f.default.TWO_UP]=new l.default;this.modes[f.default.BLEND]=new l.default(function(){var b=(0,e.default)(bitbucket.internal.component.imageDiffer.opacitySlider());a._$container.children(".since-revision").before(b);b.on("input change",
'input[type\x3d"range"]',function(b){a._$untilImg.css("opacity",parseFloat((0,e.default)(b.target).val()))})},function(){var b=a._$container.children(".opacity-slider-container");b.off("input change");b.remove();a._$untilImg.css("opacity","")});this.modes[f.default.SPLIT]=new l.default(function(){h(a._$imgs).done(function(b){a._$untilImg.wrap(bitbucket.internal.component.imageDiffer.imageContainer());a._$revisions.wrapAll(bitbucket.internal.component.imageDiffer.splitContainer());a._$untilRevisionImageContainer=
a._$untilImg.parent();a._$splitContainer=a._$container.find(".split-container");var d=void 0,c=function(){var c=a._$untilRevisionImageContainer,e=a._$splitContainer,f=k(a._$container,a._$container.parent().width());e=k(e,f);e=k(a._$sinceRevision,e);f=k(a._$sinceImg,e);var g=Math.min(b.width,f);a._$imgs.width(g);a._$imgs.height(Math.floor(g/b.width*b.height));c.height(a._$imgs.outerHeight(!0));c=g+(e-f);a._$revisions.width(c);a._$untilRevision.css("margin-left",-c);d=a._$sinceImg.outerWidth(!0)};a._onResize=
g.default.debounce(c,200);(0,e.default)(window).on("resize",a._onResize);c();50>b.width?(a._$untilRevisionLabel.css("margin-left","-50px"),a._$sinceRevisionLabel.css("margin-right","-50px")):100>b.width&&(a._$untilRevisionLabel.css("margin-left",-b.width),a._$sinceRevisionLabel.css("margin-right",-b.width));var f=function(b){a._$untilRevisionImageContainer.css("width",Math.min(b.pageX-b.data.offset.left,d))};a._$splitContainer.hover(function(){a._$revisions.on("mousemove",{offset:a._$untilRevision.offset()},
f)},function(){a._$revisions.off("mousemove",f)})})},function(){a._$imgs.css({width:"",height:""});a._$revisions.css("width","");a._$untilRevision.css("margin-left","");a._$untilRevisionLabel.add(a._$sinceRevisionLabel).css({marginLeft:"",marginRight:""});a._$untilImg.unwrap();a._$untilRevisionImageContainer.remove();delete a._$untilRevisionImageContainer;a._$revisions.unwrap();a._$splitContainer.remove();delete a._$splitContainer;a._onResize&&((0,e.default)(window).off("resize",a._onResize),delete a._onResize)});
this.modes[f.default.PIXEL_DIFF]=new l.default(function(){a._$revisions.wrapAll(bitbucket.internal.component.imageDiffer.pixelDiffContainer());a._$pixelDiffContainer=a._$container.find(".pixeldiff-container");if(a._$pixelDiffImg)a._$pixelDiffContainer.append(a._$pixelDiffImg);else{var b=(0,e.default)(bitbucket.internal.component.imageDiffer.spinner());a._$pixelDiffContainer.append(b);b.spin("large");g.default.defer(function(){var c=q(a._$sinceImg),d=q(a._$untilImg);e.default.when(c,d).then(function(a,
b){r.default.outputSettings({errorColor:{red:208,green:68,blue:55},errorType:"flat",transparency:.1});var c=e.default.Deferred();(0,r.default)(a).compareTo(b).onComplete(function(a){return c.resolve(a)});return c}).done(function(b){a._$pixelDiffImg=(0,e.default)(bitbucket.internal.component.imageDiffer.pixelDiffImage({imageSrc:b.getImageDataUrl()}));a._$pixelDiffContainer.append(a._$pixelDiffImg)}).always(function(){b.remove()})})}},function(){a._$pixelDiffImg&&a._$pixelDiffImg.remove();a._$revisions.unwrap();
a._$pixelDiffContainer.remove();delete a._$pixelDiffContainer})}}]);return c}(n.default);m.default=p;t.exports=m["default"]});