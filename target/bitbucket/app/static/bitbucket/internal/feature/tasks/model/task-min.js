define("bitbucket/internal/feature/tasks/model/task","module exports @atlassian/aui backbone backbone-brace lodash bitbucket/util/events bitbucket/util/navbuilder bitbucket/internal/feature/comments/utils bitbucket/internal/feature/tasks/model/task-state bitbucket/internal/model/stash-user".split(" "),function(r,h,k,t,u,l,v,w,n,e,x){function d(a){return a&&"bitbucket.internal.feature.pull-request-tasks."+a}Object.defineProperty(h,"__esModule",{value:!0});var g=babelHelpers.interopRequireDefault(k),
p=babelHelpers.interopRequireDefault(t);k=babelHelpers.interopRequireDefault(u);var m=babelHelpers.interopRequireDefault(l),y=babelHelpers.interopRequireDefault(v);l=babelHelpers.interopRequireDefault(w);var f=babelHelpers.interopRequireDefault(e);e=babelHelpers.interopRequireDefault(x);var z=l.default.rest().addPathComponents("tasks");e=k.default.Model.extend({namedAttributes:{id:"number",anchor:null,state:"string",author:e.default,createdDate:"number",text:"string",html:"string",properties:null,
permittedOperations:null,lastState:"string",pendingSync:"boolean",pullRequestId:"number",repositoryId:"number"},defaults:{state:f.default.OPEN,text:"",pendingSync:!1,permittedOperations:{}},url:function(){var a=z;this.isNew()||(a=a.addPathComponents(this.getId()));return a.build()},initialize:function(){this.on("sync",function(){this._previousAttributes.id||this._triggerTaskEvent(d("created"));this._triggerTaskEvent(d("saved"))})},nextState:function(){return f.default.Transitions[this.getState()]},
eventNameForState:function(a){switch(a){case f.default.OPEN:return this._previousAttributes.id?d("reopened"):d("created");case f.default.RESOLVED:return d("resolved");case f.default.DELETED:return d("deleted");default:return d("default")}},transitionToNextState:function(){return this._updateState(this.nextState())},changeState:function(a){this.set({state:a,lastState:this.getState()},{local:!0});this._triggerTaskEvent(this.eventNameForState(a))},_updateState:function(a){var c=this.getState(),q=this.eventNameForState(a),
b=this;this.changeState(a);return this.save().done(function(){b.getState()!==a&&(q=b.eventNameForState(b.getState()),b._triggerTaskEvent(q))}).fail(function(){b.set({state:c,lastState:a});b._triggerTaskEvent(d("failed-transition"))})},updateText:function(a){var c=this,d=this.getText(),b=(0,n.sanitiseText)(a);this.setText(b);return(this.save()||p.default.$.Deferred().reject(this.validationError)).fail(function(){""!==b&&c.setText(d)})},validate:function(a,c){if((0,n.sanitiseText)(a.text)!==a.text)return g.default.I18n.getText("bitbucket.web.tasks.error.invalidText");
if(""===a.text)return g.default.I18n.getText("bitbucket.web.tasks.error.missingText")},sync:function(a,c,d){this.setPendingSync(!0);c=p.default.sync(a,c,m.default.assign(d,{statusCode:{404:function(b,c,d,e){b=(b=m.default.get(e,"errors.0"))&&b.message;"create"!==a&&(b=g.default.I18n.getText("bitbucket.web.tasks.noSuchTask",bitbucket.internal.util.productName()));return{title:g.default.I18n.getText("bitbucket.web.tasks.noSuchTask.title"),message:b,shouldReload:!0,fallbackUrl:void 0}}}}));c.always(this.setPendingSync.bind(this,
!1));return c},_triggerTaskEvent:function(a,c){c===this&&(c={});y.default.trigger(a,null,m.default.assign({task:this.toJSON()},c))}},{Anchor:{COMMENT:"COMMENT"}});h.default=e;r.exports=h["default"]});