define("bitbucket/internal/feature/file-content/diff-view/diff-view","module exports jquery lodash bitbucket/internal/feature/comments/anchors bitbucket/internal/feature/file-content/diff-view-options bitbucket/internal/feature/file-content/diff-view-segment-types bitbucket/internal/feature/file-content/ediff/ediff-markers bitbucket/internal/feature/file-content/text-view/text-view bitbucket/internal/model/direction bitbucket/internal/util/array bitbucket/internal/util/events bitbucket/internal/util/function bitbucket/internal/util/object bitbucket/internal/util/shortcuts".split(" "),
function(I,y,J,K,L,M,N,O,P,Q,R,S,T,U,V){function W(a,b){return a.concat(b).sort(function(a,b){var c=f.default.head(a.lines),d=f.default.head(b.lines);a=f.default.last(a.lines);b=f.default.last(b.lines);return c.destination-d.destination||c.source-d.source||a.destination-b.destination||a.source-b.source})}function X(a,b){var c=[];return b.eachLine(function(a){var b=a.line,d=a.handles.FROM,h=a.handles.TO,e=B.clone(),f=B.clone();e.addClass("line-number-from");f.addClass("line-number-to");e.html(a.lineType!==
v?b.source:"\x26nbsp;");f.html(a.lineType!==w?b.destination:"\x26nbsp;");c.push([d||h,"line-number-from",e[0]]);c.push([h||d,"line-number-to",f[0]]);a.handles.all.forEach(function(b){var d=Y.clone();d.attr("data-file-type",b.fileType);d.attr("data-line-type",a.lineType);d.attr("data-line-number",a.lineNumber);d.html(b.lineType===v?"+":b.lineType===w?"-":"\x26nbsp;");c.push([b,"line-number-marker",d[0]])})}).done(function(){a.operation(function(){c.forEach(function(b){a.setGutterMarker.apply(a,b)})});
a._$container.addClass("fully-loaded diff-api-ready");var d=Z(b);aa(a,d);"INITIAL"===b.type&&ba(a,d)})}function C(a,b,c,d){var p=x[a];a!==z&&(p+=" modified");if(!0===d||!0===c)p+=" expanded";p+=b?" conflict conflict-"+b.toLowerCase():"";return p+(c?" new":"")}function ca(a,b){var c="INSERT"===b.type,d=[];b.eachLine(function(b){var e=C(b.lineType,b.line.conflictMarker,c,b.attributes.expanded);b.handles.all.forEach(function(b){a.addLineClass(b,"wrap",e);c&&d.push(b)})}).done(function(){d.length&&da(a,
d)})}function da(a,b){setTimeout(function(){a._editor&&a.operation(function(){f.default.forEach(b,function(b,d){a.removeLineClass(b,"wrap","new")})})},1500)}function Z(a){a=g.default.extend({},a);delete a.fileChange;return D.default.freeze(a)}function aa(a,b){a.trigger("change",b);k.default.trigger("bitbucket.internal.feature.fileContent.diffViewContentChanged",null,b)}function ba(a,b){a.trigger("load",b);k.default.trigger("bitbucket.internal.feature.fileContent.diffViewContentLoaded",null,b)}function e(a,
b){var c=this;n.default.call(this,b.$container,b);this._data=a;this._scrollingReady=new Promise(function(a){c._resolveScrolling=a})}function E(a,b,c){if(void 0!==c._line){b=b[c._lineType][c._line].handles;var d=b[c._fileType]||b.FROM||b.TO}return{anchor:c,handle:d,offset:d?a.heightAtLine(d._handle.lineNo(),"local"):0}}function F(a,b,c,d){var e=this;this._currAnimationPromise||(this._currAnimationPromise={});this._currAnimationPromise[a]&&f.default.invokeMap(this._currAnimationPromise[a],"abort");
this._currAnimationPromise[a]=d.map(function(d){function h(a,b){var d=a?"addLineClass":"removeLineClass";u.operation(function(){p.forEach(function(a){u[d](a._handle,"wrap",b)})})}var p=d.handles,u=d.editor;if(!p||!p.length)return g.default.Deferred().reject().promise({abort:g.default.noop});var k=!1,m=g.default.Deferred(),l=g.default.Deferred();m.done(l.resolve.bind(l));var A=f.default.once(function(){u.off("scroll",A);k||(e._$container&&e._$container.attr("data-last-updated",(new Date).getTime()),
h(!0,b),m.always(h.bind(null,!1,b)),h(!0,a),l.always(h.bind(null,!1,a)),setTimeout(l.resolve.bind(l),c))});u.on("scroll",A);setTimeout(A,100);return m.promise({abort:function(){k=!0;m.resolve()}})})}Object.defineProperty(y,"__esModule",{value:!0});var g=babelHelpers.interopRequireDefault(J),f=babelHelpers.interopRequireDefault(K),ea=babelHelpers.interopRequireDefault(L),G=babelHelpers.interopRequireDefault(M),q=babelHelpers.interopRequireDefault(N),fa=babelHelpers.interopRequireDefault(O),n=babelHelpers.interopRequireDefault(P),
r=babelHelpers.interopRequireDefault(Q),ha=babelHelpers.interopRequireDefault(R),k=babelHelpers.interopRequireDefault(S),t=babelHelpers.interopRequireDefault(T),D=babelHelpers.interopRequireDefault(U),H=babelHelpers.interopRequireDefault(V),v=q.default.ADDED,w=q.default.REMOVED,z=q.default.CONTEXT,B=(0,g.default)(bitbucket.internal.feature.fileContent.diffView.lineNumber()),Y=(0,g.default)(bitbucket.internal.feature.fileContent.diffView.lineNumberMarker()),x={};x[v]="added";x[w]="removed";x[z]="context";
D.default.inherits(e,n.default);e.defaults=n.default.defaults;e.contentChangeType={INITIAL:"INITIAL",INSERT:"INSERT"};e.prototype.init=function(){var a=this;n.default.prototype.init.call(this);var b=this._options.diffViewOptions||G.default;this.registerGutter("line-number-marker",{weight:1E3});this._$container.addClass("diff-type-"+this._options.fileChange.type+" animated").toggleClass("hide-ediff",b.get("hideEdiff")).toggleClass("show-whitespace-characters",b.get("showWhitespaceCharacters"));this._editors.map(function(a){return a.setOption("showWhiteSpaceCharacters",
b.get("showWhitespaceCharacters"))});var c=this;k.default.trigger("bitbucket.internal.feature.fileContent.diffViewDataLoaded",null,this._data);this.on("internal-change",function(a){X(c,a).done(function(){c._selectLine(c._options.anchor);var a=c._options.fileChange.search;a&&c._highlight(a)})});this._addDestroyable(fa.default.init({diffView:this}));this._addDestroyable(k.default.chainWith((0,g.default)(window)).on("scroll",function(){c._expectFocusScroll||c._invalidateFocus();c._expectFocusScroll=
!1}));this._addDestroyable(k.default.chainWith(b).on("change",function(a){"hideEdiff"===a.key?c._$container.toggleClass("hide-ediff",a.value):"showWhitespaceCharacters"===a.key&&(c._$container.toggleClass("show-whitespace-characters",a.value),c._editors.map(function(b){return b.setOption("showWhiteSpaceCharacters",a.value)}))}));this.on("internal.acceptedModification",t.default.spread(function(a,b,c){ca(this,{type:a,eachLine:function(a){return g.default.Deferred().resolve(f.default.map(c,a))}})}));
this._options.attachScroll?f.default.defer(function(){return a._resolveScrolling(a._attachScrollBehavior())}):this._resolveScrolling();this._addDestroyable(k.default.chain().on("bitbucket.internal.feature.diffView.lineChange",this._selectLine.bind(this)).on("bitbucket.internal.feature.diffView.highlightSearch",this._highlight.bind(this)));this._addDestroyable(H.default.bind("requestSecondaryNext",this._scrollToChange.bind(this,r.default.DOWN)));this._addDestroyable(H.default.bind("requestSecondaryPrevious",
this._scrollToChange.bind(this,r.default.UP)))};e.prototype._findNextChange=function(a,b,c){function d(a){return!!a.lines[0].conflictMarker||e._options.combineLinkedSegments&&a&&a.type!==q.default.CONTEXT}var e=this,f=!1,h=-1;null==a&&(c=r.default.DOWN,f=!0);var g,k=b.length;for(g=0;g<k;g++){var n=c===r.default.DOWN?g:k-g-1,m=b[n];if(f){var l=b[n-1];if(!(!m||m.type===q.default.CONTEXT||m.lines[0].conflictMarker&&l&&l.lines[0].conflictMarker||e._options.combineLinkedSegments&&l&&l&&l.type!==q.default.CONTEXT)){h=
n;break}}else m===a&&(f=!0)}if(-1<h){a=h;for(h+=1;h<b.length&&d(b[h]);)h++;return b.slice(a,h)}return null};e.prototype._selectLine=function(a){a&&(a=this.getLineHandleFromNumber(a.no,a.type))&&(this.scrollHandleIntoFocus(a),this._markLinesFocused([{editor:this._editorForHandle(a),handles:[a]}]))};e.prototype._scrollToChange=function(a){var b=this._focusedSegments&&this._focusedSegments[0];b||(b=this._$fileToolbar.outerHeight(),b=this._$container[0].getBoundingClientRect().top-b,b=this._getFocusSegment(b));
if(a=this._findNextChange(b,this._allSegments,a))this._setFocusSegment(a),this._expectFocusScroll=!0,this._focusedSegments=a};e.prototype._scrollToComment=function(a){G.default.set("hideComments",!1);var b=f.default.chain(this._options.commentContext._containers).map("anchor").filter(function(a){return a instanceof ea.default.LineAnchor}).uniqBy(t.default.invoke("getId")).value();if(a=this._findNextAnchor(a,b,this._focusedComment))this._expectFocusScroll=!0,this._focusedComment=a,a.handle?(this._highlightCommentForLine(a.handle),
this.scrollHandleIntoFocus(a.handle)):this._scrollToSourcePosition(null,-this._editorInnerOffset())};e.prototype._invalidateFocus=function(){this._focusedComment=this._focusedSegments=null};e.prototype._findNextAnchorInEditor=function(a,b,c,d){if(0===b.length)return null;b=f.default.sortBy(b,t.default.dot("_line"));if(d){var e=ha.default.findIndex(t.default.propEqual(f.default.pick(d.anchor,"_line","_lineType","_fileType")))(b);if(-1!==e)return(c=b[e+(c===r.default.UP?-1:1)])&&E(a,this._internalLines,
c)}if(d)var g=d.offset;else d=this._$fileToolbar.outerHeight(),d=this._$container[0].getBoundingClientRect().top-d,e=a.getScrollInfo(),g=e.top+this._options.focusPoint*e.clientHeight-d;a=b.map(E.bind(null,a,this._internalLines));return c===r.default.UP?f.default.find(a.reverse(),function(a){return a.offset<g}):f.default.find(a,function(a){return a.offset>g})};e.prototype._highlightCommentForLine=function(a){this._markLineCommentsFocused([{editor:this._editorForHandle(a),handles:[a]}])};e.prototype.getLineHandleFromNumber=
function(a,b){var c="TO"===b?this._internalLines[v][a]:this._internalLines[w][a];return(c=(c=c||f.default.find(this._internalLines[z],t.default.dotEq("TO"===b?"line.destination":"line.source",a)))&&c.handles)&&(c[b]||c.all[0])};e.prototype._acceptModification=function(){throw Error("DiffView implementation must define this.");};e._combineTexts=function(a){return f.default.chain(a).map("line").map("line").value().join(n.default.DEFAULT_LINE_ENDING)};e.prototype._getChangeAttributes=function(a,b){return{diff:b,
fileChange:this._options.fileChange}};e.prototype._getLineClasses=C;e.prototype._modifyDiff=function(a,b,c){var d=[].slice.call(arguments,3);this._allSegments=W(this._allSegments||[],f.default.chain(b.hunks).map("segments").flattenDeep().value());this._modify.apply(this,[a,b,c].concat(d))};e.prototype._markLinesFocused=f.default.partial(F,"line-focused","last-focus",1E3);e.prototype._markLineCommentsFocused=f.default.partial(F,"line-comment-focused","last-comment-focus",1E3);y.default=e;I.exports=
y["default"]});