define("bitbucket/internal/feature/file-content/commit-selector/commit-selector","module exports @atlassian/aui jquery lodash bitbucket/util/navbuilder bitbucket/internal/model/path bitbucket/internal/util/ajax bitbucket/internal/util/events bitbucket/internal/widget/keyboard-controller bitbucket/internal/widget/paged-scrollable".split(" "),function(u,h,k,v,w,x,y,z,A,B,C){function c(a){var b=this,d=a.id;a=a.buttonEl;this._$selectorButton=(0,e.default)(a);this._id="#inline-dialog-"+d;this._scrollPaneSelector=
this._id+" .commit-selector";this._listSelector=this._scrollPaneSelector+" \x3e ul";this._scrollable=null;var c=!1,f=void 0,g=function(a){var d=(0,e.default)(a.currentTarget);if(!d.hasClass("disabled")){var c=d.children("a").attr("data-id");c=b._visibleCommits[c];var l=b._preloadItems[d.index()],f=l&&l.commitRange,g=null,h=null;n.default.get(c,"properties.change")&&(g=c.properties.change.path?new p.default(c.properties.change.path):null,h=c.properties.change.srcPath?new p.default(c.properties.change.srcPath):
null);(0,e.default)("li",b._listSelector).removeClass("selected");d.addClass("selected");b._renderButton(c,l);m();q.default.trigger("bitbucket.internal.feature.commitselector.itemSelected",b,{commitJSON:c,commitRangeJSON:f,pullRequest:b._pullRequest,path:g,sincePath:h})}a.preventDefault()},m=function(){b._inlineDialog.removeAttr("open")};this.resetDialog=function(){b._$selectorButton.removeClass("active");b._scrollable&&b._scrollable.reset();f&&f.off("click","li.commit-list-item",g);(0,e.default)(window).off("scroll",
m);c=!1};this._inlineDialog=(0,e.default)(this._id);this._inlineDialog.on("aui-show",function(a){b._$selectorButton.addClass("active");if(!c){var d=(0,e.default)(a.target).find(".aui-inline-dialog-contents");f=d.html(bitbucket.internal.feature.fileContent.commitSelector());f.on("click","li.commit-list-item",g);b._scrollable=b._createScrollable();b._visibleCommits={};setTimeout(function(){d.find(".spinner-container").spin();b._scrollable.init()},0);b._initialiseKeyboardNavigation();b._initialiseMouseNavigation()}(0,
e.default)(window).on("scroll",m)}).on("aui-hide",this.resetDialog);this._events=q.default.chain().on("bitbucket.internal.feature.commitselector.itemSelected",this.resetDialog).on("bitbucket.internal.page.*.revisionRefChanged",this.resetDialog).on("bitbucket.internal.page.*.pathChanged",this.resetDialog)}function D(a,b){n.default.forEach(a,function(a){b[a.id]=a})}Object.defineProperty(h,"__esModule",{value:!0});var E=babelHelpers.interopRequireDefault(k),e=babelHelpers.interopRequireDefault(v),n=
babelHelpers.interopRequireDefault(w),r=babelHelpers.interopRequireDefault(x),p=babelHelpers.interopRequireDefault(y),t=babelHelpers.interopRequireDefault(z),q=babelHelpers.interopRequireDefault(A);k=babelHelpers.interopRequireDefault(B);var F=babelHelpers.interopRequireDefault(C),G=k.default.ListKeyboardController;c.prototype.init=function(a){this._commitRange=a.commitRange;this._followRenames=a.followRenames;this._headRevisionRef=a.headRevisionReference;this._itemTemplate=a.itemTemplate;this._itemTitle=
a.itemTitle;this._itemUrl=a.itemUrl;this._itemExtraClasses=a.itemExtraClasses;this._mode=a.mode;this._path=a.path;this._preloadItems=a.preloadItems||[];this._pullRequest=a.pullRequest;this._selectedCommit=a.selectedCommit;this._updateButton=a.updateButton;this._lastPageMessage=a.lastPageMessage||E.default.I18n.getText("bitbucket.web.file.history.allhistoryfetched");this._includesMerge=a.includesMerge||!1;this._renderButton(a.selectedCommit,a.selectedItem)};c.prototype.destroy=function(){this.resetDialog();
this._events.destroy();this._inlineDialog.remove();this._resultsKeyboardController&&(this._resultsKeyboardController.destroy(),this._resultsKeyboardController=null)};c.prototype._createScrollable=function(){var a=new F.default(this._scrollPaneSelector,{bufferPixels:0,pageSize:25,paginationContext:"file-history",preventOverscroll:!0});a.requestData=this.requestData.bind(this);a.attachNewContent=this.attachNewContent.bind(this);var b=a.onFirstDataLoaded;a.onFirstDataLoaded=function(){return b.apply(this,
arguments)};return a};c.prototype.requestData=function(a,b){this._inlineDialog.find(".spinner-container").spin();var d=void 0;d=this._pullRequest?r.default.rest().currentRepo().pullRequest(this._pullRequest.id).commits().withParams({start:a,limit:b,avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"xsmall"})}):r.default.rest().currentRepo().commits().withParams({followRenames:this._followRenames,path:this._path.toString(),until:this._headRevisionRef.getId(),start:a,limit:b,avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"xsmall"})});
return t.default.rest({url:d.build()}).done(function(a){return 0<a.size?a:t.default.rest({url:d.withParams({followRenames:!1}).build()})})};c.prototype._renderItem=function(a,b,d){return bitbucket.internal.widget.commit.commitListItem({content:this._itemTemplate({commit:a,href:this._itemUrl(a,this)}),isFocused:b,isSelected:d,extraClasses:this._itemExtraClasses&&this._itemExtraClasses(a).join(" "),title:this._itemTitle?this._itemTitle(a.displayId):""})};c.prototype.attachNewContent=function(a){var b=
this;D(a.values,this._visibleCommits);var d=this._selectedCommit&&this._selectedCommit.id,c=a.values.map(function(c){return b._renderItem(c,d===c.id&&0===a.start,d===c.id)}),f=this._preloadItems&&0===a.start?this._preloadItems.map(function(a){var c={href:a.href,icon:a.icon,messageHtml:a.messageHtml,size:a.size},d=["preload-item"];a.disabled&&d.push("disabled");b._itemExtraClasses&&(d=d.concat(b._itemExtraClasses(a)));return bitbucket.internal.widget.commit.commitListItem({isSelected:a.selected,extraClasses:d.join(" "),
content:bitbucket.internal.feature.fileContent.commitSelectorUrlItem(c)})}):null,g=(0,e.default)(this._listSelector);g.append(f).append(c);c=(0,e.default)(this._scrollPaneSelector).children(".spinner-container");c.spinStop();a.isLastPage&&(g.append(bitbucket.internal.feature.fileContent.commitSelectorNoMoreResults({lastPageMessage:this._lastPageMessage})),c.remove())};c.prototype.isButtonEnabled=function(){return!this._$selectorButton.prop("disabled")};c.prototype.getSelectedCommit=function(){if(this._visibleCommits&&
this._selectedCommit&&this._selectedCommit.id)return this._visibleCommits[this._selectedCommit.id]};c.prototype.refreshCommit=function(a,b){var c=this._visibleCommits[a];if(c)return c=this._visibleCommits[a]=babelHelpers.extends({},c,b),b=(0,e.default)(this._listSelector).find(".commit-selector-item-message[data-id\x3d'"+a+"']").parent(),c=this._renderItem(c,b.hasClass("focused"),b.hasClass("selected")),b.replaceWith(c),this._visibleCommits[a];console.warn("Unable to refresh commit with id "+a)};
c.prototype._initialiseKeyboardNavigation=function(){var a=this,b=(0,e.default)(a._scrollPaneSelector);a._resultsKeyboardController&&a._resultsKeyboardController.destroy();a._resultsKeyboardController=new G(a._$selectorButton,a._listSelector,{focusedClass:"focused",itemSelector:"li.commit-list-item",adjacentItems:!0,requestMore:function(){var b=a._scrollable.loadAfter();return b&&b.then(function(a){return a.isLastPage})},onSelect:function(b){a._inlineDialog.is(":visible")?b.click():a._$selectorButton.click()},
onFocusLastItem:function(){b.scrollTop(b[0].scrollHeight)}})};c.prototype._initialiseMouseNavigation=function(){var a=(0,e.default)(this._listSelector);a.on("mouseenter","li",function(b){b=(0,e.default)(b.currentTarget);b.find(".focused").length||(a.find(".focused").removeClass("focused"),b.addClass("focused"))})};c.prototype._renderButton=function(a,b){if(this._updateButton)if(a)this._$selectorButton.children().first().replaceWith(bitbucket.internal.feature.fileContent.singleCommitIcon()),this._$selectorButton.find(".text").text(a.message);
else if(b)b.icon&&this._$selectorButton.children().first().replaceWith(b.icon),this._$selectorButton.toggleClass("commit-selector-large","large"===b.size),this._$selectorButton.find(".text").html(b.messageHtml);else throw Error("PreloadItems must provide a selectionContent HTML string to render into the dropdown button when they are selected");};h.default=c;u.exports=h["default"]});