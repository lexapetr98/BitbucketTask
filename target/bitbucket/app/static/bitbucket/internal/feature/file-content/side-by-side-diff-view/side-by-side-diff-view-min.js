define("bitbucket/internal/feature/file-content/side-by-side-diff-view/side-by-side-diff-view","module exports jquery lodash bitbucket/internal/feature/file-content/diff-hunk-map/diff-hunk-map bitbucket/internal/feature/file-content/diff-line-info bitbucket/internal/feature/file-content/diff-view-file-types bitbucket/internal/feature/file-content/diff-view-segment-types bitbucket/internal/feature/file-content/diff-view/diff-view bitbucket/internal/feature/file-content/line-handle bitbucket/internal/feature/file-content/side-by-side-diff-view/synchronized-scroll bitbucket/internal/model/direction bitbucket/internal/util/events bitbucket/internal/util/function bitbucket/internal/util/math bitbucket/internal/util/object bitbucket/internal/util/performance bitbucket/internal/util/promise bitbucket/internal/util/svg bitbucket/internal/feature/file-content/stash-codemirror/search".split(" "),
function(G,t,u,H,I,J,K,L,M,N,O,P,Q,R,S,T,v,U,V){function h(a,b){b.combineLinkedSegments=!0;m.default.apply(this,arguments)}function W(a){var b=a&&a._seg;return b&&b.type!==n.default.CONTEXT&&0<a._numLines}function w(a){return a.conflicted||!!a._seg.lines[0].conflictMarker}function X(a){function b(a){if(!(this instanceof b))return new b(a);this._regions=[a];this.conflicted=!0;this.classesInfo={lineType:a._seg.type,conflictMarker:a._seg.lines[0].conflictMarker};this.getOffsetTop=function(){return this._regions[0].getOffsetTop()};
this.getHeight=function(){return g.default.chain(this._regions).invokeMap("getHeight").reduce(Y.default.add).value()};this.push=function(a){this._regions.push(a)}}return a.reduce(function(a,d){var c=a.previous,f=c&&g.default.some(c,w),q=g.default.some(d,w);if(q&&f)return g.default.forEach(c,function(a,b){a.push(d[b])}),a;q&&(d=g.default.map(d,b));a.previous=d;a.regions.push(d);return a},{previous:null,regions:[]}).regions.filter(function(a){return a.some(l.default.or(W,w))})}function Z(a,b,c){function d(a,
b){if(a.region.classesInfo)return a.region.classesInfo;a=a.region._lineInfos[0];b=b.region._lineInfos[0];return a?{conflictMarker:a.line.conflictMarker,lineType:a.lineType}:{conflictMarker:null,lineType:b.lineType}}var e,f=b.offsetHeight||parseFloat((e=window.getComputedStyle(b)).height);e=b.offsetWidth||parseFloat(e.width);var q=e+1,r=.4*e,z=.6*e;for(a=a.map(function(a){return a.map(function(a){var b=0;if(a._editor.getWrapperElement().classList.contains("searching")){b=a._editor.getScrollerElement().getBoundingClientRect().top;
var c=a._editor.getWrapperElement().getBoundingClientRect().top;b-=c}b=a.getOffsetTop()+b;c=b+a.getHeight();return{region:a,top:b+.5,bottom:c+.5,above:0>b,inside:0<c&&b<f,below:c>f}})}).filter(function(a){return a.some(l.default.dot("inside"))||a.some(l.default.dot("above"))&&a.some(l.default.dot("below"))}).map(l.default.spread(function(a,b){var e=(new p.default.PathBuilder).moveTo(-1,a.top).curve(r,a.top,z,b.top,q,b.top).lineTo(q,b.bottom).curve(z,b.bottom,r,a.bottom,-1,a.bottom).close().build();
var f=d(a,b);a=d(b,a);f=c(f.lineType,f.conflictMarker,!1)+" "+c(a.lineType,a.conflictMarker,!1);f=g.default.uniq(f.split(/\s+/)).join(" ");return{path:e,extraClasses:f}}));b.hasChildNodes();)b.removeChild(b.firstChild);e=g.default.once(function(a){var b=[{class:"removed",offset:"0%"},{class:"removed",offset:"30%"},{class:"added",offset:"70%"},{class:"added",offset:"100%"}];b=g.default.map(b,p.default.createElement.bind(p.default,"stop"));return g.default.reduce(b,function(a,b){a.appendChild(b);return a},
p.default.createElement("linearGradient",{id:a}))});a=a.map(function(a){var b={class:"segment-connector "+a.extraClasses,d:a.path};a=a.extraClasses;g.default.includes(a,"added")&&g.default.includes(a,"removed")&&(b.fill="url(#added-and-removed-svg-gradient)");return p.default.createElement("path",b)}).concat(e("added-and-removed-svg-gradient")).reduce(function(a,b){a.appendChild(b);return a},document.createDocumentFragment());b.appendChild(a)}Object.defineProperty(t,"__esModule",{value:!0});var A=
babelHelpers.interopRequireDefault(u),g=babelHelpers.interopRequireDefault(H),B=babelHelpers.interopRequireDefault(I),aa=babelHelpers.interopRequireDefault(J),k=babelHelpers.interopRequireDefault(K),n=babelHelpers.interopRequireDefault(L),m=babelHelpers.interopRequireDefault(M),ba=babelHelpers.interopRequireDefault(N),ca=babelHelpers.interopRequireDefault(O),C=babelHelpers.interopRequireDefault(P),x=babelHelpers.interopRequireDefault(Q),l=babelHelpers.interopRequireDefault(R),Y=babelHelpers.interopRequireDefault(S);
u=babelHelpers.interopRequireDefault(T);var D=babelHelpers.interopRequireDefault(v);v=babelHelpers.interopRequireDefault(U);var p=babelHelpers.interopRequireDefault(V),da=v.default.tryWithLogging,E=n.default.ADDED,ea=n.default.CONTEXT,F=n.default.REMOVED;u.default.inherits(h,m.default);h.defaults=m.default.defaults;h.prototype.init=function(){var a=this;if(this._$container){this._$container.addClass("side-by-side-diff");this._$container.append(bitbucket.internal.feature.fileContent.sideBySideDiffView.layout());
this.fromEditorEl=this._$container.find(".side-by-side-diff-editor-from");this.toEditorEl=this._$container.find(".side-by-side-diff-editor-to");var b=this._options.commentContext&&this._options.commentContext.getGutterId();b&&this.registerGutter(b,{weight:100});this.registerGutter("line-number-from",{weight:200,fileType:k.default.FROM});this.registerGutter("line-number-to",{weight:200,fileType:k.default.TO});this._fromEditor=this._createEditor({gutterFilter:function(a){return!a.fileType||a.fileType===
k.default.FROM}},this.fromEditorEl);this._toEditor=this._createEditor({gutterFilter:function(a){return!a.fileType||a.fileType===k.default.TO}},this.toEditorEl);b=l.default.dot("hunks.0.segments.0")(this._data.diff);var c=l.default.dot("hunks.0.segments.0.lines.0.line")(this._data.diff),d=l.default.dot("hunks.0.segments.1.lines.0.line")(this._data.diff),e=b.type===E?d:c,f=l.default.dot("srcPath.name")(this._options.fileChange)?this._options.fileChange.srcPath.name:this._options.fileChange.path.name;
this._syntaxHighlighting(f,e,this._fromEditor);this._syntaxHighlighting(this._options.fileChange.path.name,b.type===F&&d?d:c,this._toEditor);this._lineInfos=aa.default.convertToLineInfos(this._data.diff,this._options);this._scrollingReady.finally(da(function(){a._fromEditor&&(a._modifyDiff("INITIAL",a._data.diff,a._lineInfos),a._setupFindScrollIntoViewFunction(a._fromEditor,k.default.FROM),a._setupFindScrollIntoViewFunction(a._toEditor,k.default.TO))}));this.on("internal-load",function(){this._syncScrollingInfo&&
(this.setupHunkmaps(this._syncScrollingInfo.linkedFromAndToRegions),this._initSegmentLinking(this._syncScrollingInfo.linkedFromAndToRegions),this.on("internal-change",function r(){this._whenOpDone(this._scrollEditorToFirstChange.bind(this));this.off("internal-change",r)}))});b=this.refresh.bind(this);x.default.on("bitbucket.internal.feature.sidebar.expandEnd",b);x.default.on("bitbucket.internal.feature.sidebar.collapseEnd",b);x.default.on("bitbucket.internal.feature.commit.difftree.collapseAnimationFinished",
b);m.default.prototype.init.call(this)}};h.prototype.destroy=function(){m.default.prototype.destroy.call(this);this._toEditor=this._fromEditor=null};h.prototype._acceptModification=function(a,b,c){function d(a,b,c){var d;g.default.forEach(a,function(a,e){e=b.getLineHandle(e);a._setHandle(c,new ba.default(c,a.lineType,a.lineNumber,e));d&&d.segment!==a.segment&&d.lineType===n.default.CONTEXT&&a.lineType===n.default.CONTEXT&&b.addLineClass(e,"wrap","paired-with-change");d=a})}if("INITIAL"!==a)throw Error("Unrecognized change type: "+
a);a=g.default.reject(c,{lineType:E});c=g.default.reject(c,{lineType:F});this._fromEditor.setValue(m.default._combineTexts(a));this._toEditor.setValue(m.default._combineTexts(c));d(a,this._fromEditor,k.default.FROM);d(c,this._toEditor,k.default.TO)};var y={};y[k.default.FROM]="_fromEditor";y[k.default.TO]="_toEditor";h.prototype._editorForHandle=function(a){return this[y[a.fileType]]};h.prototype._getFocusSegment=function(a){var b=this._fromEditor.getScrollInfo().clientHeight*this._options.focusPoint;
if(a>b)return null;var c=b+this._syncScrollingInfo.combinedScrollable._getScrollTop()-a+1;c=Math.ceil(c);return(g.default.find(this._syncScrollingInfo.combinedRegions,function(a){return a._getOffset()<=c&&a._getOffset()+a.getHeight()>c})||g.default.last(this._syncScrollingInfo.combinedRegions))._seg};h.prototype._setFocusSegment=function(a){function b(a,b){return g.default.compact(a.map(function(a){return a.handles[b]}))}var c=g.default.filter(this._syncScrollingInfo.combinedRegions,function(b){return g.default.includes(a,
b._seg)}),d=this._fromEditor.getScrollInfo().clientHeight*this._options.focusPoint;this._scrollToSourcePosition(null,c[0]._getOffset()-d);var e=g.default.chain(c).flatMap("_linkedRegions").flatMap("_lineInfos").uniq().value(),f=this;this.operation(function(){f._markLinesFocused([{editor:f._fromEditor,handles:b(e,k.default.FROM)},{editor:f._toEditor,handles:b(e,k.default.TO)}])})};h.prototype._findNextAnchor=function(a,b,c){var d=g.default.groupBy(b,l.default.dot("_fileType"));b=d.FROM&&this._findNextAnchorInEditor(this._fromEditor,
d.FROM,a,c);c=d.TO&&this._findNextAnchorInEditor(this._toEditor,d.TO,a,c);return b&&c?a===C.default.UP&&c.offset<b.offset||a===C.default.DOWN&&c.offset>=b.offset?b:c:b||c||null};h.prototype.setupHunkmaps=function(a){function b(a,b,d){var f=a.getScrollInfo(),h=Math.max(0,f.height*d-f.clientHeight*e);a=g.default.findIndex(b,function(a){var b=f.top+a.getOffsetTop();return b<=h&&b+a.getHeight()>h});b=b[a];a=c._syncScrollingInfo.combinedRegions[a];d=c._syncScrollingInfo.combinedScrollable.getScrollInfo();
b=(h-(f.top+b.getOffsetTop()))/b.getHeight();b=d.top+a.getOffsetTop()+b*a.getHeight();c._scrollToSourcePosition(0,b)}var c=this,d=a.map(g.default.head);a=a.map(g.default.last);var e=this._options.focusPoint,f=new B.default(this.fromEditorEl,d,{scrollToFn:g.default.partial(b,this._fromEditor,d)}),h=new B.default(this.toEditorEl,a,{scrollToFn:g.default.partial(b,this._toEditor,a)});d=g.default.debounce(g.default.invokeMap.bind(g.default,[f,h],"redraw"),100);this._addDestroyable(f);this._addDestroyable(h);
this.on("widgetAdded",d);this.on("widgetChanged",d);this.on("widgetCleared",d);this.on("resize",d);this._fromEditor.on("scroll",function(a){f.diffScrolled(a.getScrollInfo())});this._toEditor.on("scroll",function(a){h.diffScrolled(a.getScrollInfo())});this._addDestroyable(function(){c._fromEditor=null;c._toEditor=null})};h.prototype._attachScrollBehavior=function(){var a=this,b=this._fromEditor,c=this._toEditor,d=this._lineInfos;if(!b)return A.default.Deferred().reject();var e=ca.default.setupScrolling(this,
d,b,c,{includeCombinedScrollable:!0,focusHeightFraction:a._options.focusPoint});this._syncScrollingInfo=e;var f=a._$container.children(".diff-editor, .segment-connector-column"),g;b=this._requestWindowScrolls({scrollSizing:function(){return e.combinedScrollable.getScrollInfo()},scroll:function(a,b){null!=b&&e.combinedScrollable.scrollToNative(null,b)},resize:function(b,c){g!==c&&(g=c,e.combinedScrollable.setClientHeight(c),f.height(c),a.refresh())},onSizeChange:function(b){a.on("resize",b)}});this._addDestroyable(e);
return b};h.prototype._initSegmentLinking=function(a){var b=(0,A.default)(".segment-connector-column"),c=p.default.createElement("svg",{});b.append(c);var d=Z.bind(null,X(a),c,this._getLineClasses);a=D.default.enqueueCapped(requestAnimationFrame,function(){c.setAttribute("height",b.height());c.setAttribute("width",b.width());d()});var e=D.default.enqueueCapped(requestAnimationFrame,d);this.on("sync-scroll",d);this.on("widgetAdded",e);this.on("widgetChanged",e);this.on("widgetCleared",e);this.on("resize",
a);a()};h.prototype.scrollHandleIntoFocus=function(a){var b=this._editorForHandle(a),c=b.getScrollInfo(),d=a.fileType===k.default.FROM?0:1;a.lineType===ea&&a.fileType===k.default.TO&&(b=this._fromEditor,d=0);var e=g.default.findIndex(this._syncScrollingInfo.linkedFromAndToRegions,function(b){return b[d]._startIndex<=a.lineNumber&&b[d]._endIndex>a.lineNumber}),f=this._syncScrollingInfo.linkedFromAndToRegions[e][d];e=this._syncScrollingInfo.combinedRegions[e];f=b.heightAtLine(a.lineNumber)-b.heightAtLine(f._startIndex);
f=this._syncScrollingInfo.combinedScrollable.getScrollInfo().top+e.getOffsetTop()+f;this._scrollToFocusedOffset(f,c,b)};h.prototype._setupFindScrollIntoViewFunction=function(a,b){var c=this;a.setOption("scrollLineIntoViewFunc",function(a){c.scrollHandleIntoFocus(c.getLineHandleFromNumber(a.from.line,b))})};h.prototype._scrollEditorToFirstChange=function(){var a=this._findNextChange(null,this._allSegments);a&&this._setFocusSegment(a)};t.default=h;G.exports=t["default"]});