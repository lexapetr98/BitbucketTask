define("bitbucket/internal/feature/file-content/source-view/source-view","module exports @atlassian/aui jquery lodash bitbucket/util/events bitbucket/util/navbuilder bitbucket/internal/feature/file-content/editor-mode bitbucket/internal/feature/file-content/line-handle bitbucket/internal/feature/file-content/request-source bitbucket/internal/feature/file-content/source-line-info bitbucket/internal/feature/file-content/text-view/attach-simple-scroll-behavior bitbucket/internal/feature/file-content/text-view/text-view bitbucket/internal/util/deep-linking bitbucket/internal/util/function bitbucket/internal/util/object bitbucket/internal/util/promise bitbucket/internal/util/property bitbucket/internal/util/shortcuts".split(" "),
function(x,m,n,p,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M){function N(b){b=f.default.assign({},b);return t.default.freeze(b)}function O(b,a){var d=[],c=document.createElement("div");c.innerHTML=bitbucket.internal.feature.fileContent.sourceView.lineNumber();var P=c.childNodes[0];return a.eachLine(function(a){var b=P.cloneNode(!0);b.setAttribute("data-line-number",a.lineNumber);b.setAttribute("href","#"+a.lineNumber);b.appendChild(document.createTextNode(a.lineNumber));d.push([a.handles.SOURCE,"line-number",b])}).done(function(){b.operation(function(){d.forEach(function(a){b.setGutterMarker.apply(b,
a)})});var c=N(a);b.trigger("change",c);u.default.trigger("bitbucket.internal.feature.fileContent.sourceViewContentChanged",null,c);"INITIAL"===a.type&&(b.trigger("load",c),u.default.trigger("bitbucket.internal.feature.fileContent.sourceViewContentLoaded",null,c))})}function e(b,a){var d=this;g.default.call(this,a.$container,a);var c=this;this._editor=this._createEditor();65279===b.lines[0].text.charCodeAt(0)&&(b.lines[0].text=b.lines[0].text.substr(1),this._hasBOM=!0);this._syntaxHighlighting(a.fileChange.path.name,
b.lines[0].text,this._editor);this.registerGutter("line-number",{weight:1E3});this._$focusedLines=(0,h.default)([]);this.on("internal-change",function(b){O(c,b).done(function(){a.anchor&&c._whenOpDone(function(){c.updateAnchor(a.anchor,!0)})})});this._scrollingReady=new Promise(function(a){d._resolveScrolling=a});this._scrollingReady.then(k(function(){d._modify("INITIAL",b,q.default.convertToLineInfos(b));d._editor.setOption("scrollLineIntoViewFunc",function(a){d.scrollHandleIntoFocus(d.getLineHandle({lineNumber:a.from.line}))})}));
this._scrollingReady.then(k(function(){return d._loadRest(b)}));this.editing=this._getEditingContext(b)}Object.defineProperty(m,"__esModule",{value:!0});var h=babelHelpers.interopRequireDefault(p),f=babelHelpers.interopRequireDefault(y),u=babelHelpers.interopRequireDefault(z),R=babelHelpers.interopRequireDefault(A),v=babelHelpers.interopRequireDefault(B),S=babelHelpers.interopRequireDefault(C),T=babelHelpers.interopRequireDefault(D),q=babelHelpers.interopRequireDefault(E),U=babelHelpers.interopRequireDefault(F),
g=babelHelpers.interopRequireDefault(G),l=babelHelpers.interopRequireDefault(H),V=babelHelpers.interopRequireDefault(I),t=babelHelpers.interopRequireDefault(J);p=babelHelpers.interopRequireDefault(K);var W=babelHelpers.interopRequireDefault(L),r=babelHelpers.interopRequireDefault(M),k=p.default.tryWithLogging;t.default.inherits(e,g.default);e.defaults=g.default.defaults;e.prototype.init=function(){var b=this;g.default.prototype.init.call(this);var a=this;this._options.attachScroll?f.default.defer(function(){return b._resolveScrolling(b._attachScrollBehavior())}):
this._resolveScrolling();this._addDestroyable(r.default.bind("sourceViewFindPrev",function(){a._editor.execCommand("findPrev")}));this._addDestroyable(r.default.bind("sourceViewFindNext",function(){a._editor.execCommand("findNext")}));this._addDestroyable(r.default.bind("sourceViewFind",function(){a._editor.execCommand("find")}));var d=f.default.last(l.default.hashToLineNumbers(window.location.hash));(0,h.default)(this._editor.getWrapperElement()).on("click contextmenu",".line-locator",function(a){var b=
parseInt((0,h.default)(a.target).attr("href").substring(1),10);if(a.shiftKey||a.ctrlKey||a.metaKey){a.preventDefault();var c=l.default.hashToLineNumbers(window.location.hash);a=l.default.updateSelectionRange(b,{existingLineNumbers:c,selectRange:!!a.shiftKey,lastSelected:d});location.hash=l.default.lineNumbersToHash(a);b=f.default.includes(a,b)?b:null}d=b})};e.prototype.setFocusedLines=function(b,a){this._$focusedLines=this._$focusedLines.removeClass("target").filter();f.default.isEmpty(b)||(b=b.map(function(a){return{lineNumber:a}}).map(this.getLineHandle).filter(f.default.identity),
b.length&&(this._$focusedLines=(0,h.default)(b.map(V.default.dot("_handle.gutterMarkers.line-number")).filter(function(a){return a})).addClass("target"),a&&this.scrollHandleIntoFocus(f.default.head(b))))};e.prototype.updateAnchor=function(b,a){this.setFocusedLines(l.default.hashToLineNumbers(b),a)};e.prototype._getEditingContext=function(b){var a=this;if(!b.isLastPage)return{editable:!1,reason:n.I18n.getText("bitbucket.web.sourceview.button.edit.uneditable.large")};if(b.lines.some(function(a){return f.default.includes(a.text,
"\ufffd")}))return{editable:!1,reason:n.I18n.getText("bitbucket.web.sourceview.button.edit.uneditable.replacement")};var d=void 0,c=function(){d||(d=a._editor.getDoc().copy(),h())},e=function(){d&&((0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).discardChanges&&a._editor.swapDoc(d),Q(),d=null)},h=function(){a._$container.addClass("editing");a._editor.switchEditorMode(v.default.EDIT);a._editor.clearGutter("line-number");a._scrollingReady.then(k(function(a){return a&&a.destroy()}));a._editor.refresh();
a._editor.focus();var b=a._editor.getScrollInfo().top,c=a._editor.defaultTextHeight()/2;b=a._editor.lineAtHeight(b+c,"local");a._editor.setCursor({ch:0,line:b})},Q=function(){a._editor.switchEditorMode(v.default.READONLY);a._$container.removeClass("editing");var b={lines:a._editor.getDoc().getValue().split("\n").map(function(a){return{text:a}})};a._modify("UPDATE",b,q.default.convertToLineInfos(b));a._scrollingReady=Promise.resolve(a._options.attachScroll?a._attachScrollBehavior():void 0);a._scrollingReady.then(k(function(){return a._editor.scrollTo(0,
0)}))},w=function(){return d?a._editor.getDoc().getValue(g.default.DEFAULT_LINE_ENDING)!==d.getValue():!1},X=function(){return new Blob([(a._hasBOM?String.fromCharCode(65279):"")+a._editor.getDoc().getValue(g.default.DEFAULT_LINE_ENDING)+g.default.DEFAULT_LINE_ENDING])},Y=function(b){var c=function(){return b(w())};a._editor.on("changes",c);var d=function(){a._editor.off("changes",c)};a._addDestroyable(d);return d},Z={editable:!1,reason:n.I18n.getText("bitbucket.web.sourceview.button.edit.uneditable.truncated")};
return b.lines.some(function(a){return a.truncated})?Z:{editable:!0,startEditing:c,stopEditing:e,hasChanged:w,getContent:X,changes:Y}};e.prototype._acceptModification=function(b,a,d,c){c=c||0;var e=this._editor;a=f.default.chain(a.lines).map("text").join(g.default.DEFAULT_LINE_ENDING).value();switch(b){case "INITIAL":e.setValue(a);break;case "INSERT":e._insert(a,c);break;case "UPDATE":break;default:throw Error("Unrecognized change type: "+b);}d.forEach(function(a,b){b=new S.default(void 0,void 0,
a.lineNumber,e.getLineHandle(b+c));a._setHandle(b)})};e.prototype._attachScrollBehavior=function(){return(0,U.default)(this,this._editor,(0,h.default)(this._editor.getWrapperElement()))};e.prototype._getChangeAttributes=function(b,a){return{firstLine:a.start+1,isLastPage:a.isLastPage}};e.prototype._loadRest=function(b){function a(b,d){var e={start:b,limit:d-b};return(0,T.default)(c._options.fileChange,e).then(function(c){return c.size<e.limit&&!c.isLastPage?a(b+c.size,d).then(function(a){return{start:c.start,
lines:c.lines.concat(a.lines),size:c.size+a.size,isLastPage:a.isLastPage}}):c})}function d(a,b){b&&c._modify("INSERT",b,q.default.convertToLineInfos(b),a)}var c=this,e=b.start,f=b.start+b.size;W.default.getFromProvider("display.max.source.lines").done(function(g){var l=0<e?a(0,e):h.default.Deferred().resolve(),k=!b.isLastPage&&f<g?a(f,g):h.default.Deferred().resolve();h.default.when(l,k).done(function(a,e){c._editor&&(c._editor.operation(function(){d(0,a);d(c._editor.lastLine()+1,e);k.then(function(a){(a?
!a.isLastPage:f>=g&&!b.isLastPage)&&c._renderCapacityReached()})}),c._$container.addClass("fully-loaded"),c.trigger("resize"))})})};e.prototype._renderCapacityReached=function(){var b=this._options.fileChange;b=(0,h.default)(bitbucket.internal.feature.fileContent.sourceView.capacityReachedLineWidget({rawUrl:R.default.currentRepo().raw().path(b.path).at(b.commitRange.untilRevision.id).build()}))[0];this._$container.addClass("capacity-reached");this._editor.addLineWidget(this._editor.lastLine(),b,{coverGutter:!0,
noHScroll:!0});this.trigger("resize")};e.prototype._editorForHandle=function(){return this._editor};m.default=e;x.exports=m["default"]});