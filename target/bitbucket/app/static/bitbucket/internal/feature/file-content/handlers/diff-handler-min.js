define("bitbucket/internal/feature/file-content/handlers/diff-handler","module exports jquery lodash bitbucket/feature/files/file-handlers bitbucket/util/events bitbucket/util/navbuilder bitbucket/internal/feature/comments/comments bitbucket/internal/feature/file-content/binary-diff-view/binary-diff-view bitbucket/internal/feature/file-content/binary-view/binary-view bitbucket/internal/feature/file-content/content-message/content-message bitbucket/internal/feature/file-content/diff-view-options bitbucket/internal/feature/file-content/diff-view-options-panel/diff-view-options-panel bitbucket/internal/feature/file-content/handlers/diff-handler/diff-handler-internal bitbucket/internal/feature/file-content/request-diff bitbucket/internal/feature/file-content/side-by-side-diff-view/side-by-side-diff-view bitbucket/internal/feature/file-content/unified-diff-view/unified-diff-view bitbucket/internal/model/file-change bitbucket/internal/model/file-change-types bitbucket/internal/model/file-content-modes bitbucket/internal/model/path bitbucket/internal/util/ajax bitbucket/internal/util/promise".split(" "),
function(z,l,A,w,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T){function U(a,d,c){var h=a.$container,b=new n.default(a.fileChange);return a.commentMode!==p.default.commentMode.NONE?(d=c?u.default.groupBy(c.values,function(a){return a.anchor.line?"line":"file"}):{line:d.lineComments||[],file:d.fileComments||[]},p.default.bindContext(h,new p.default.DiffAnchor(b),{lineComments:d.line,fileComments:d.file,commentMode:a.commentMode,relevantContextLines:a.relevantContextLines,diffViewOptions:a.diffViewOptions,
$toolbar:a.$toolbar,urlBuilder:a.commentUrlBuilder})):null}function V(a,d,c,m){var b=d.diff,f=W.default.builtInHandlers,k=a.$container,g=new n.default(a.fileChange);if(b&&(b.binary||X.default.treatTextAsBinary(b.destination&&b.destination.extension)))return c=new Y.default(b,a),c.handlerID=c.isDiffingImages()?f.DIFF_IMAGE:f.DIFF_BINARY,c;if(!b||!b.hunks||!b.hunks.length)return q.default.renderEmptyDiff(k,d,g),{handlerID:f.DIFF_EMPTY,extraClasses:"empty-diff message-content"};if(b.hunks[b.hunks.length-
1].truncated)return q.default.renderTooLargeDiff(k,b,g,m),{handlerID:f.DIFF_TOO_LARGE,extraClasses:"too-large-diff message-content"};a=new (m?Z.default:aa.default)(d,h.default.extend({commentContext:c},a));c&&c.setDiffView(a);u.default.defer(a.init.bind(a));a.handlerID=m?f.DIFF_TEXT_SIDE_BY_SIDE:f.DIFF_TEXT_UNIFIED;return a}Object.defineProperty(l,"__esModule",{value:!0});var h=babelHelpers.interopRequireDefault(A),u=babelHelpers.interopRequireDefault(w),W=babelHelpers.interopRequireDefault(B),ba=
babelHelpers.interopRequireDefault(C),ca=babelHelpers.interopRequireDefault(D),p=babelHelpers.interopRequireDefault(E),Y=babelHelpers.interopRequireDefault(F),X=babelHelpers.interopRequireDefault(G),q=babelHelpers.interopRequireDefault(H),da=babelHelpers.interopRequireDefault(I),ea=babelHelpers.interopRequireDefault(J),v=babelHelpers.interopRequireDefault(K),fa=babelHelpers.interopRequireDefault(L),Z=babelHelpers.interopRequireDefault(M),aa=babelHelpers.interopRequireDefault(N),n=babelHelpers.interopRequireDefault(O),
r=babelHelpers.interopRequireDefault(P),ha=babelHelpers.interopRequireDefault(Q),ia=babelHelpers.interopRequireDefault(R),x=babelHelpers.interopRequireDefault(S),y=babelHelpers.interopRequireDefault(T);l.default={handler:function(a){function d(a){return"side-by-side"===a.get("diffType")&&k}function c(a){var b=new n.default(a.fileChange),e=b.getRepository();b=b.getCommitRange();e=ca.default.rest().project(e.getProject().getKey()).repo(e.getSlug());e=(a.commentUrlBuilder?a.commentUrlBuilder():b.getPullRequest()?
e.pullRequest(b.getPullRequest().getId()).comments():e.commit(b).comments()).withParams({avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:a.avatarSize||"medium"}),path:(new ia.default(a.fileChange.path)).toString(),markup:!0}).build();a=a.statusCode||x.default.ignore404WithinRepository();h.default.extend(a,{401:function(){return h.default.Deferred().resolve({start:0,size:0,values:[],isLastPage:!0,filter:null}).promise()}});a=x.default.rest({url:e,statusCode:a});return a.then(function(a){return a.errors&&
a.errors.length?h.default.Deferred().rejectWith(this,[this,null,null,a]):a}).promise(a)}if(a.contentMode!==ha.default.DIFF)return!1;a.diffViewOptions||(a.diffViewOptions=da.default);var m=a.$container,b=new n.default(a.fileChange),f=b.getType(),k=!(f===r.default.ADD||f===r.default.DELETE||a.isExcerpt);a.withComments=a.commentMode!==p.default.commentMode.NONE;d(a.diffViewOptions)&&(a.contextLines=v.default.infiniteContext,a.withComments=!1);var g=d(a.diffViewOptions)?c:h.default.noop;g=u.default.compact([(0,
fa.default)(b,a),g(a)]);return y.default.whenAbortable.apply(y.default,g).thenAbortable(function(c,g){var e=c.diff;b.getType()&&b.getType!==r.default.UNKNOWN||(b.setType(r.default.guessChangeTypeFromDiff(e)),a.fileChange=b.toJSON());0===(0,w.get)(e,"hunks.0.sourceSpan")?k=!1:f||(k=!v.default.isAddedOrRemoved(e));a.diffViewOptions=v.default.optionsOverride(a.diffViewOptions,k,a.isExcerpt);a.relevantContextLines=a.relevantContextLines||10;b.getConflict()&&q.default.renderConflict(m,b);var n=new ea.default((0,
h.default)(document),a.diffViewOptions);g=U(a,e||{},g);var t=V(a,c,g,d(a.diffViewOptions)),l=[];ba.default.trigger("bitbucket.internal.feature.fileContent.handlingDiff",null,{fileHandlingContext:a,data:c,mainView:t,onDestroy:function(a){return l.push(a)}});return{handlerID:t.handlerID,extraClasses:t.extraClasses,destroy:function(){p.default.unbindContext(a.$container);[t,n,a.diffViewOptions].forEach(function(a){a&&a.destroy&&a.destroy()});l.forEach(function(a){return a()})}}},function(a,b,c,d){if("abort"===
c)return h.default.Deferred().resolve();q.default.renderErrors(m,d);return h.default.Deferred().resolve({extraClasses:"diff-error message-content"})})}};z.exports=l["default"]});