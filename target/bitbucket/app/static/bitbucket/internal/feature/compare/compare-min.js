define("bitbucket/internal/feature/compare/compare","module exports @atlassian/aui baconjs jquery lodash bitbucket/util/navbuilder bitbucket/internal/feature/pull-request/create-form/pull-request-create bitbucket/internal/feature/repository/source-target-selector/source-target-selector bitbucket/internal/model/repository bitbucket/internal/model/revision-reference bitbucket/internal/util/analytics bitbucket/internal/util/bacon bitbucket/internal/util/dom-event bitbucket/internal/util/events bitbucket/internal/util/function bitbucket/internal/util/history bitbucket/internal/util/shortcuts bitbucket/internal/widget/keyboard-shortcuts/keyboard-shortcuts".split(" "),
function(B,n,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S){function T(a,b,e,c){var f=c.sourceRepo,d=u.default.project(c.sourceRepo.getProject()).repo(c.sourceRepo);d=b||a?d.createPullRequest():d.compare()[e]();c.target&&!c.target.isDefault()&&(d=d.targetBranch(c.target.getId()));c.source&&!c.source.isDefault()&&(d=d.sourceBranch(c.source.getId()));d=d.targetRepo(c.targetRepo.getId());d=d.build();var k=c.targetRepo?u.default.project(c.targetRepo.getProject()).repo(c.targetRepo).createPullRequest().build():"";
return{url:d,formURL:k,title:b||a?p.default.I18n.getText("bitbucket.web.pullrequest.create.windowtitle",f.getProject().getName(),f.getName()):p.default.I18n.getText("bitbucket.web.repository.compare.page.title",f.getProject().getName(),f.getName()),selector:c,prShowing:b,tab:e}}function v(a){return a.branchesSelected()}function U(a){var b=function(){return{source:a.getSourceBranch(),sourceRepo:a.getSourceRepository(),target:a.getTargetBranch(),targetRepo:a.getTargetRepository()}},e="source.repositoryChanged source.revisionRefChanged source.revisionRefUnselected target.repositoryChanged target.revisionRefChanged target.revisionRefUnselected".split(" ").map(function(a){return l.default.events("bitbucket.internal.feature.repository.sourceTargetSelector."+
a)});return m.default.mergeAll.apply(m.default,e).map(b).toProperty(b())}function V(a){function b(a){a.addClass("active-tab").attr("aria-selected","true").siblings().attr("aria-selected","false").removeClass("active-tab");c();a=e[a.attr("data-module-key")];c=a.init();W.default.resetContexts();return a.pathSegment}var e=g.default.reduce(a,function(a,b){a["compare-"+b.pathSegment+"-tab"]=b;return a},{}),c=h.default.noop;a=b(t.find(".active-tab"));return t.asEventStream("click","a").filter(w.default.openInSameTab).doAction(w.default.preventDefault()).flatMap(function(a){a=
(0,h.default)(a.currentTarget).parent();return a.is(".active-tab")?m.default.never():m.default.constant(b(a))}).toProperty(a)}function X(a,b){function e(){f();c.empty();f=b(c)}var c=(0,h.default)("#compare-content"),f=h.default.noop,d=l.default.events("bitbucket.internal.feature.repository.sourceTargetSelector.source.revisionRefChanged").merge(l.default.events("bitbucket.internal.feature.repository.sourceTargetSelector.target.revisionRefChanged")).map(q.default.constant(a)).filter(v).onValue(e);v(a)&&
e();return function(){f();d()}}function Y(){Z.default.bind("requestBranchCompareSectionHandler",function(a){a=parseInt(String.fromCharCode(a.which),10);t.children().eq(a-1).children("a").click()});l.default.events("bitbucket.internal.widget.keyboard-shortcuts.register-contexts").onValue(function(a){a.enableContext("branch-compare")})}function aa(a,b,e,c,f,d){var k=(0,h.default)(".aui-page-header-main h2"),x=d.find(".expanded-branches"),g=d.find("#sourceRepo"),m=d.find("#pull-request-description");
a.doAction(c,"toggleClass","hidden").doAction(x,"toggleClass","hidden").not().doAction(f.toggleClass.bind(f,"hidden")).doAction(function(a){a=a?["pullRequest","compare"]:["compare","pullRequest"];ba.default.trigger("bitbucket.internal.feature.compare.form.state",null,{oldForm:a[0],newForm:a[1]});"pullRequest"===a[1]&&ca.default.add("branch-compare.pullRequest.create")}).doAction(function(a){(a?g:m).focus()}).map(function(a){return a&&!e?p.default.I18n.getText("bitbucket.web.repository.compare.header.title"):
p.default.I18n.getText("bitbucket.web.pullrequest.create.title")}).onValue(k.text.bind(k));a.combine(b,function(a,b){return{prShowing:a,selector:b}}).onValue(function(a){a.prShowing?(a=bitbucket.internal.feature.compare.collapsedBranches({sourceBranch:a.selector.source.toJSON(),targetBranch:a.selector.target.toJSON()}),(0,h.default)(a).insertBefore(x)):d.find(".collapsed-branches").remove()})}function da(a){return(0,h.default)(document).asEventStream("click",".show-hide-button").map(function(b){return(0,
h.default)(b.target).is(a)}).toProperty(a.hasClass("hidden"))}function ea(a,b){var e=a.debounce(0).map(function(a){var b={canCreate:!1};a.source&&a.target?a.source.isTag()||a.target.isTag()?b.reason="TAG_SELECTED":a.source.isEqual(a.target)?b.reason="REFS_EQUAL":b.canCreate=!0:b.reason="REF_UNSELECTED";return b}).skipDuplicates().toProperty();a=b.find("#show-create-pr-button");var c=b.find(".refs-equal-warning"),f=b.find(".tags-warning"),d=b.find(".aui-tabs");b=e.doAction(function(a){c.toggleClass("hidden",
"REFS_EQUAL"!==a.reason);f.toggleClass("hidden","TAG_SELECTED"!==a.reason);d.toggleClass("hidden","REF_UNSELECTED"===a.reason)}).map(q.default.dot("canCreate"));b.doAction(a,"enable").not().onValue(a,"attr","aria-disabled");return b}function fa(a,b,e,c){var f=e.find("#cancel-button"),d=l.default.events("bitbucket.internal.history.popstate").filter(q.default.not(q.default.dotEq("state",null)));return m.default.combineAsArray(a,d).sampledBy(d).filter(function(a){return 0!==g.default.keys(a[1].state).length}).map(function(a){var b=
a[0];return{prShowing:b[0],tab:b[1],selector:b[2],oldState:a[1].state}}).onValue(function(a){a.prShowing!==a.oldState.prShowing&&(a.prShowing?f.click():b.click());a.tab!==a.oldState.tab&&e.find("li.menu-item[data-module-key\x3dcompare-"+a.oldState.tab+"-tab] \x3e a").click();a=a.oldState.selector;c.refSelectors.source.setSelection({repository:a.sourceRepo?new r.default(a.sourceRepo):null,branch:a.source?new y.default(a.source):null});c.refSelectors.target.setSelection({repository:a.targetRepo?new r.default(a.targetRepo):
null,branch:a.target?new y.default(a.target):null})})}function z(a){var b=g.default.clone(a);b.selector={};g.default.forEach(a.selector,function(a,c){b.selector[c]=a?a.toJSON():null});return b}Object.defineProperty(n,"__esModule",{value:!0});var p=babelHelpers.interopRequireDefault(C),m=babelHelpers.interopRequireDefault(D),h=babelHelpers.interopRequireDefault(E),g=babelHelpers.interopRequireDefault(F),u=babelHelpers.interopRequireDefault(G),ha=babelHelpers.interopRequireDefault(H),ia=babelHelpers.interopRequireDefault(I),
r=babelHelpers.interopRequireDefault(J),y=babelHelpers.interopRequireDefault(K),ca=babelHelpers.interopRequireDefault(L),l=babelHelpers.interopRequireDefault(M),w=babelHelpers.interopRequireDefault(N),ba=babelHelpers.interopRequireDefault(O),q=babelHelpers.interopRequireDefault(P),A=babelHelpers.interopRequireDefault(Q),Z=babelHelpers.interopRequireDefault(R),W=babelHelpers.interopRequireDefault(S),t=(0,h.default)(".tabs-menu");n.default={onReady:function(a,b){a=(0,h.default)(a);b.prCreateMode=!!b.prCreateMode;
var e=g.default.map(b.additionalPreloadRepositories,q.default.create(r.default)),c=new ia.default(a.find(".compare-selector"),new r.default(b.sourceRepositoryJson),new r.default(b.targetRepositoryJson),e,{showTags:!0}),f=V(g.default.map(b.tabs,function(a,b){return{pathSegment:b,init:g.default.partial(X,c,g.default.partial(a,c))}})),d=U(c),k=ea(d,a),l=a.find(".pull-request-create-form");e=a.find("#show-create-pr-button");var p=a.find("form.aui");ha.default.init(l,b.submittedReviewers||[],d,f,k);k=
da(e);aa(k,d,b.prCreateMode,e,l,a);var n=!0;f=m.default.combineAsArray(k,f,d);fa(f,e,a,c);f.map(Function.apply.bind(g.default.partial(T,b.prCreateMode)),null).onValue(function(a){p.attr("action",a.formURL);n?(A.default.initialState(z(a)),n=!1):g.default.includes(window.location.href,a.url)||A.default.pushState(z(a),a.title,a.url)});Y()}};B.exports=n["default"]});