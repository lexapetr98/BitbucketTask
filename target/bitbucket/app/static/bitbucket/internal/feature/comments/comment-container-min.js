define("bitbucket/internal/feature/comments/comment-container","module exports @atlassian/aui backbone jquery lodash bitbucket/util/navbuilder bitbucket/internal/feature/comments/comment-collection bitbucket/internal/feature/comments/comment-model bitbucket/internal/feature/comments/comment-tips bitbucket/internal/model/page-state bitbucket/internal/util/dom-event bitbucket/internal/util/events bitbucket/internal/util/function bitbucket/internal/util/history bitbucket/internal/util/syntax-highlight bitbucket/internal/util/time-i18n-mappings bitbucket/internal/widget/aui/form/form bitbucket/internal/widget/confirm-dialog/confirm-dialog bitbucket/internal/widget/markup-editor/markup-editor".split(" "),
function(x,m,n,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O){Object.defineProperty(m,"__esModule",{value:!0});var g=babelHelpers.interopRequireDefault(n);n=babelHelpers.interopRequireDefault(y);var e=babelHelpers.interopRequireDefault(z),k=babelHelpers.interopRequireDefault(A),P=babelHelpers.interopRequireDefault(B),Q=babelHelpers.interopRequireDefault(C),r=babelHelpers.interopRequireDefault(D),t=babelHelpers.interopRequireDefault(E),h=babelHelpers.interopRequireDefault(F),R=babelHelpers.interopRequireDefault(G),
f=babelHelpers.interopRequireDefault(H),u=babelHelpers.interopRequireDefault(I),S=babelHelpers.interopRequireDefault(J),v=babelHelpers.interopRequireDefault(K),p=babelHelpers.interopRequireDefault(L),q=babelHelpers.interopRequireDefault(M),T=babelHelpers.interopRequireDefault(N),w=babelHelpers.interopRequireDefault(O);m.default=n.default.View.extend({initialize:function(){k.default.bindAll(this,"onCommentEditorResize","onCommentFocused");this.anchor=this.anchor||this.options.anchor;this.rootCommentListSelector=
this.rootCommentListSelector||this.options.rootCommentListSelector;this.context=this.options.context;this.pullRequest=this.options.pullRequest||h.default.getPullRequest();this.urlBuilder=this.options.urlBuilder;this.collection||(this.collection=new Q.default([],{anchor:this.anchor,urlBuilder:this.urlBuilder}));this.initDeleteButtons();this.$el.imagesLoaded(this.onImagesLoaded.bind(this));f.default.trigger("bitbucket.internal.feature.comments.commentContainerAdded",null,this.$el);this.updateDraftComment=
k.default.debounce(this.updateDraftComment,300);this.deleteDraftComment=k.default.debounce(this.deleteDraftComment,300);this.on("comment.saved",v.default.container.bind(null,this.$el));v.default.container(this.$el);f.default.once("bitbucket.internal.feature.pullRequestActivity.focused",this.onCommentFocused)},events:{"submit form":"onFormSubmit","click a.times":"onDateClicked","click .cancel":"onCancelClicked","click .reply":"onReplyClicked","click .edit":"onEditClicked","click .task-create":"onCreateTaskClicked",
"keydown form":"onFormKeydown","input textarea":"onTextareaInput","comment-child-added .comment ":"onChildrenChanged","comment-child-removed .comment ":"onChildrenChanged"},initDeleteButtons:function(a){this.createDeleteDialog().attachTo(".delete",null,this.el)},createDeleteDialog:function(){var a=this,b=new T.default({id:"delete-repository-dialog",titleText:g.default.I18n.getText("bitbucket.web.comment.delete.title"),titleClass:"warning-header",panelContent:"\x3cp\x3e"+g.default.I18n.getText("bitbucket.web.comment.delete.confirm")+
"\x3c/p\x3e",submitText:g.default.I18n.getText("bitbucket.web.button.delete"),submitToHref:!1,focusSelector:".cancel-button"});b.addConfirmListener(function(b,c,e){e();a.deleteComment(c.closest(".comment"))});return b},sendOverviewAnalyticsEvent:function(a,b,d){(0,e.default)(a).closest("#pull-request-activity")&&f.default.trigger("bitbucket.internal.feature.pullRequest."+b,null,d)},onFormSubmit:function(a){a.preventDefault();a.stopPropagation();this.submitCommentForm((0,e.default)(a.target))},onDateClicked:function(a){a.preventDefault();
a.stopPropagation();(0,e.default)(".comment.focused").removeClass("focused");a=(0,e.default)(a.target).closest("a");a.closest(".comment").addClass("focused");S.default.pushState(null,null,a.prop("href"))},onCancelClicked:function(a){a.preventDefault();a.stopPropagation();this.cancelCommentForm((0,e.default)(a.target).closest("form"))},onReplyClicked:function(a){a.originalEvent instanceof MouseEvent&&this.sendOverviewAnalyticsEvent(a.target,"overview.comment.reply.clicked");a.preventDefault();a.stopPropagation();
this.openReplyForm((0,e.default)(a.target).closest(".comment"))},onEditClicked:function(a){this.sendOverviewAnalyticsEvent(a.target,"overview.comment.edit.clicked");a.preventDefault();a.stopPropagation();this.openEditForm((0,e.default)(a.target).closest(".comment"))},onCreateTaskClicked:function(a){this.sendOverviewAnalyticsEvent(a.target,"overview.comment.task.clicked");a.preventDefault();a.stopPropagation();a=(0,e.default)(a.target).closest(".comment");f.default.trigger("bitbucket.internal.feature.tasks.createTask",
null,a)},onImagesLoaded:function(a){this.trigger("change")},onFormKeydown:function(a){R.default.isCtrlEnter(a)&&(a.preventDefault(),a.stopPropagation(),(0,e.default)(a.target).closest("form").submit())},onTextareaInput:function(a){(0,e.default)(a.target).closest(".comment-container").is(this.el)&&this.updateDraftComment(a.target)},onChildrenChanged:function(a){if(a.target!==a.currentTarget){a.stopPropagation();a=(0,e.default)(a.currentTarget);var b=a.find("\x3e .content .task-list-row, \x3e .replies \x3e .comment").not(".pending-delete").length;
a.find("\x3e .content \x3e .actions \x3e li \x3e .delete").parent().toggleClass("hidden",!!b)}},onCommentFocused:function(a){var b=P.default.parse(window.location).getQueryParamValue("action"),d={"comment.id":this.getCommentJSON(a.closest(".comment")).id};"reply"===b?(a.find(".reply").first().click(),this.sendOverviewAnalyticsEvent(a,"comment.actions.reply",d)):"view"===b&&this.sendOverviewAnalyticsEvent(a,"comment.actions.view",d)},updateDraftComment:function(a){a=this.getDraftCommentFromForm((0,
e.default)(a).closest("form"));this.context&&this.context.saveDraftComment(a)},getDraftCommentFromForm:function(a){a=this.getCommentFormJSON(a);a.anchor&&delete a.anchor.commitRange;return e.default.extend({},a)},deleteDraftComment:function(a){this.context&&this.context.deleteDraftComment(a)},getRootCommentList:function(){var a=this.$(this.rootCommentListSelector);a.length||(a=this.$el);return a},render:function(){var a=bitbucket.internal.feature.comments(e.default.extend({comments:this.collection.toJSON(),
customMapping:p.default.commentEditedAge,pullRequest:this.options.anchor.getPullRequest()},this.anchor.toJSON()));this.$el.replaceWith(a);this.setElement(a[0])},_toJSON:function(a,b){var d=parseInt(a.parent().closest(".comment").attr("data-id"),10),c=parseInt(a.attr("data-id"),10);a=parseInt(a.attr("data-version"),10);var e=this.anchor.toJSON();return{id:isNaN(c)?void 0:c,version:isNaN(a)?void 0:a,text:b,anchor:e,parent:isNaN(d)?void 0:{id:d}}},getCommentJSON:function(a){return this._toJSON(a,a.find("\x3e .content \x3e .message").attr("data-text"))},
getCommentFormJSON:function(a){var b=a.parent().is(".comment")?a.parent():a;return this._toJSON(b,a.find("textarea").val())},renderContentUpdate:function(a,b){a.children(".content").replaceWith(bitbucket.internal.feature.commentContent({pullRequest:this.pullRequest&&this.pullRequest.toJSON(),comment:b,hideDelete:!!a.find("\x3e .replies \x3e .comment").length,customMapping:p.default.commentEditedAge}));a.attr("data-version",b.version).data("version",b.version);this.$el.imagesLoaded(this.onImagesLoaded.bind(this));
this.scrollToComment(a);this.trigger("change");f.default.trigger("bitbucket.internal.feature.comments.commentEdited",null,b,a)},insertCommentIntoList:function(a,b,d){for(var c=b.children(".comment:first");c.length&&!(parseInt(c.data("id"),10)>d.id);)c=c.next(".comment");c=c.length?c:b.children(".comment-form-container:last");c.length?a.insertBefore(c):b.append(a)},renderComment:function(a,b,d){var c;if(d&&(c=(0,e.default)('.comment[data-id\x3d"'+a.id+'"]')).length)return this.renderContentUpdate(c,
a);a=e.default.extend({isNew:!0},a);b=(c=b&&this.$("[data-id\x3d"+b+"]"))?c.children(".replies"):this.getRootCommentList();c=(0,e.default)(bitbucket.internal.feature.comment({pullRequest:this.pullRequest&&this.pullRequest.toJSON(),numOfAncestors:b.parents(".comment").length,extraClasses:this.getExtraCommentClasses(),comment:a,customMapping:p.default.commentEditedAge}));this.insertCommentIntoList(c,b,a);setTimeout(k.default.bind(c.removeClass,c,"new"),5E3);this.scrollToComment(c);c.hide().fadeIn("slow");
this.$el.imagesLoaded(this.onImagesLoaded.bind(this));this.trigger("change");f.default.trigger("bitbucket.internal.feature.comments.commentAdded",null,a,c);c.trigger("comment-child-added")},getExtraCommentClasses:function(){return""},showErrorMessage:function(a,b){a=this.find(".error");a.length||(a=(0,e.default)('\x3cdiv class\x3d"error"\x3e\x3c/div\x3e'),this.find(".comment-form-footer").before(a));a.text(b)},cancelCommentForm:function(a){this.closeCommentForm(a)},submitCommentForm:function(a){if(!q.default.isSubmissionPrevented(a)){var b=
this,d=a.find(".comment-submit-spinner"),c=this.getCommentFormJSON(a),f=null!=c.id,g=f&&this.collection.get(c.id),h=c.parent&&c.parent.id,l=g?this.collection.get(c.id):new r.default;l.on("invalid",this.showErrorMessage,a);l.set(e.default.extend(c,{avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"medium"})}),{validate:!0})&&(g||this.collection.push(l),a.addClass("submitting"),d.spin("medium"),q.default.preventSubmission(a),l.save().done(function(c){c.createdDate=Math.min(c.createdDate,(new Date).getTime());
c.updatedDate=Math.min(c.updatedDate,(new Date).getTime());b.closeCommentForm(a,{doNotDestroy:!0});b.renderComment(c,h,f);b.trigger("comment.saved")}).fail(function(){g||f||b.collection.remove(c.id)}).always(function(){d.spinStop();a.removeClass("submitting");q.default.allowSubmission(a)}));l.off("invalid",this.showErrorMessage)}},deleteComment:function(a){var b=this.getCommentJSON(a);if(this.collection.get(b))var d=this.collection.get(b.id);else d=new r.default(b),this.collection.push(d);var c=a.find("\x3e .content .delete"),
e=c.height(),h=c.width();c.height(e).width(h).css("vertical-align","middle").empty().spin("small");var k=this;d.destroy({wait:!0}).always(function(){c.spinStop()}).done(function(){a.addClass("pending-delete").fadeOut(function(){a.trigger("comment-child-removed").remove();k.onCommentDeleted();k.trigger("change");f.default.trigger("bitbucket.internal.feature.comments.commentDeleted",null,b)})}).fail(function(){c.css("height","").css("width","").css("vertical-align","").text(g.default.I18n.getText("bitbucket.web.comment.delete"))})},
onCommentDeleted:function(){},onCommentEditorResize:e.default.noop,openEditForm:function(a){var b=this.getCommentJSON(a);b=(0,e.default)(bitbucket.internal.feature.commentForm(e.default.extend({tips:450<this.$el.width()?t.default.tips:[],currentUser:h.default.getCurrentUser()&&h.default.getCurrentUser().toJSON()},b)));var d=a.find("\x3e .user-avatar, \x3e .content");d.detach();a.prepend(b).addClass("comment-form-container");b.data("originalContent",d);this._bindMarkupEditor(b);this.focusCommentForm(b);
this.trigger("change");f.default.trigger("bitbucket.internal.feature.comments.commentFormShown",null,b);return b},openReplyForm:function(a){a=a.children(".replies");return this.openCommentForm(a,{location:"top"})},openNewCommentForm:function(){return this.openCommentForm(this.getRootCommentList(),{location:"bottom"})},openCommentForm:function(a,b){b=b&&"top"===b.location?"prependTo":"appendTo";var d=a.children(".comment-form-container").not(".comment");d.length||(d=(0,e.default)(bitbucket.internal.feature.commentFormListItem({tips:450<
this.$el.width()?t.default.tips:[],currentUser:h.default.getCurrentUser()&&h.default.getCurrentUser().toJSON()}))[b](a),this._bindMarkupEditor(d.find("form")));a=d.find("form");this.focusCommentForm(a);this.trigger("change");f.default.trigger("bitbucket.internal.feature.comments.commentFormShown",null,a);return a},closeCommentForm:function(a){a.find(".error").remove();this.deleteDraftComment(this.getDraftCommentFromForm(a));this._unbindMarkupEditor(a);var b=a.data("originalContent"),d=a.parent();
b?(d.removeClass("comment-form-container"),a.replaceWith(b)):d.remove();this.trigger("change");f.default.trigger("bitbucket.internal.feature.comments.commentFormHidden",null,a)},focusCommentForm:u.default.lazyDefer(function(a){this.scrollToComment(a);a.find("textarea").focus()}),scrollToComment:e.default.noop,populateCommentFormFromDraft:function(a,b){(0,e.default)(a).find("textarea").val(b.text).addClass("restored").attr("title",g.default.I18n.getText("bitbucket.web.comment.restored.draft.title")).trigger("input").one("click input",
function(){(0,e.default)(this).removeClass("restored").removeAttr("title")})},getCommentElById:function(a){return this.$(".comment[data-id\x3d"+a+"]")},restoreDraftComment:function(a){if(a.id){var b=this.getCommentElById(a.id);if(b.length){if(parseInt(a.version,10)<parseInt(b.attr("data-version"),10))return this.context.deleteDraftComment(a),!0;var d=this.openEditForm(b)}}else a.parent?(b=this.getCommentElById(a.parent.id),b.length&&(d=this.openReplyForm(b))):d=this.openNewCommentForm();d&&this.populateCommentFormFromDraft(d,
a);return!!d},_bindMarkupEditor:function(a){w.default.bindTo(a).on("resize",this.onCommentEditorResize)},_unbindMarkupEditor:function(a){w.default.unbindFrom(a)},destroy:function(){this.$("form").each(u.default.thisToParam(this._unbindMarkupEditor.bind(this)))}});x.exports=m["default"]});