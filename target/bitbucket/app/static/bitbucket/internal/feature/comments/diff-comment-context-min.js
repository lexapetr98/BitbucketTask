define("bitbucket/internal/feature/comments/diff-comment-context","module exports jquery lodash bitbucket/internal/feature/comments/anchors bitbucket/internal/feature/comments/comment-collection bitbucket/internal/feature/comments/comment-context bitbucket/internal/feature/comments/diff-comment-container bitbucket/internal/feature/file-content/diff-view-file-types bitbucket/internal/feature/file-content/diff-view-options bitbucket/internal/feature/file-content/diff-view-segment-types bitbucket/internal/model/direction bitbucket/internal/util/events bitbucket/internal/util/function bitbucket/internal/util/shortcuts bitbucket/internal/util/time-i18n-mappings".split(" "),
function(v,l,m,w,x,y,z,A,B,C,D,E,F,G,H,I){Object.defineProperty(l,"__esModule",{value:!0});var f=babelHelpers.interopRequireDefault(m),c=babelHelpers.interopRequireDefault(w);m=babelHelpers.interopRequireDefault(x);var J=babelHelpers.interopRequireDefault(y),h=babelHelpers.interopRequireDefault(z),r=babelHelpers.interopRequireDefault(A),t=babelHelpers.interopRequireDefault(B),K=babelHelpers.interopRequireDefault(C),n=babelHelpers.interopRequireDefault(D),u=babelHelpers.interopRequireDefault(E),p=
babelHelpers.interopRequireDefault(F),k=babelHelpers.interopRequireDefault(G),q=babelHelpers.interopRequireDefault(H),L=babelHelpers.interopRequireDefault(I),M=m.default.LineAnchor;l.default=h.default.extend({events:{"click .add-comment-trigger":"addCommentClicked","mouseenter .dummy-comment-trigger, .add-comment-trigger":"initTooltip"},initialize:function(){this._destroyables=[];c.default.bindAll(this,"onDiffChange","onFileCommentsResized","onCommentContainerDestroyed","onDiffViewOptionsChange");
this._initFileCommentButton=this._initFileCommentButton.bind(this,this.options.$toolbar);this._destroyables.push(p.default.chain().once("bitbucket.internal.feature.fileContent.requestHandled",this._initFileCommentButton));this.setDiffView(this.options.diffView);this._dvOptions=this.options.diffViewOptions||K.default;this._commentsById=this.options.lineComments&&c.default.keyBy(this.options.lineComments,k.default.dot("id"));this.$el.toggleClass("commentable",this.options.allowCommenting);this.toggleComments(!this._dvOptions.get("hideComments"));
this._dvOptions.on("change",this.onDiffViewOptionsChange);p.default.on("bitbucket.internal.comment.commentContainerDestroyed",this.onCommentContainerDestroyed);this.renderFileComments();h.default.prototype.initialize.apply(this,arguments);var a=this._getFileCommentContainer();a&&this._initializeFileCommentContainer(a)},_initFileCommentButton:function(a){a.find(".add-file-comment-trigger").on("click",this.addFileCommentClicked.bind(this)).tooltip({gravity:"ne"})},_initializeFileCommentContainer:function(a){a.on("resize",
this.onFileCommentsResized)},_getFileCommentContainer:function(){var a=this.options.anchor.getId();if(this.includesContainer(a))return this._containers[a]},_registerContainer:function(a,b,c){this._containers[a]=new r.default({anchor:c,context:this,el:b,name:a,urlBuilder:this.options.urlBuilder});return this._containers[a]},addFileCommentClicked:function(){this.forceShowingComments();this.addCommentContainerForFile().openNewCommentForm()},initTooltip:function(a){a=(0,f.default)(a.currentTarget);a.data("tooltip-inited")||
(a.data("tooltip-inited",!0),a.tooltip({gravity:"w",delayOut:200}).trigger("mouseenter"))},addCommentClicked:function(a){a.preventDefault();this.forceShowingComments();a=(0,f.default)(a.target).closest(".line");this.addCommentContainerForLine(a).openNewCommentForm()},forceShowingComments:function(){this._dvOptions.get("hideComments")&&this._dvOptions.set("hideComments",!1)},addCommentContainerForFile:function(){var a=this._getFileCommentContainer();if(a)return a;a=(0,f.default)(bitbucket.internal.feature.comments(this.options.anchor.toJSON()));
a.appendTo(this.$(".file-comments"));this.registerContainer(a[0],this.options.anchor);a=this._getFileCommentContainer();this._initializeFileCommentContainer(a);return a},addCommentContainerForLine:function(a,b){var c=this.getLineAnchor(a);a=a.lineType?a:this.diffView.getLineHandle(a);var d=c.getId(),g=this.options.urlBuilder;this.includesContainer(d)||(this._containers[d]=new r.default({anchor:c,collection:b?new J.default(b,{anchor:c,urlBuilder:g}):void 0,context:this,lineHandle:a,name:d,showComments:!this._dvOptions.get("hideComments"),
urlBuilder:g}));return this._containers[d]},destroy:function(a){a||(this.diffView&&this.diffView.off("change",this.onDiffChange),this.$el.removeClass("commentable"),this._dvOptions.off("change",this.onDiffViewOptionsChange),this._dvOptions=null,p.default.off("bitbucket.internal.comment.commentContainerDestroyed",this.onCommentContainerDestroyed),c.default.invokeMap(this._destroyables,"destroy"),this._destroyables=null);h.default.prototype.destroy.apply(this,arguments)},findContainerElements:function(){return this.$(".line .comment-box, .file-comments \x3e .comment-container")},
getAnchor:function(a){return(0,f.default)(a).closest(".file-comments").length?this.options.anchor:this.getLineAnchor((0,f.default)(a).closest(".line"))},getGutterId:function(){return this.options.allowCommenting?"add-comment-trigger":null},getLineAnchor:function(a){a=a.lineType?a:this.diffView.getLineHandle(a);return new M(this.options.anchor,a.lineType,a.lineNumber,a.fileType)},renderFileComments:function(){var a=this.options.anchor.getPullRequest();this.$el.prepend(bitbucket.internal.feature.fileComments({comments:this.options.fileComments,
pullRequest:a,customMapping:L.default.commentEditedAge}))},addAnchoredComments:function(){var a=this,b=this.diffView,e=this.options.lineComments;e&&e[0]&&!e[0].anchor||c.default.forEach(function(a){return c.default.chain(a).filter(function(a){return!(!a.anchor||!a.anchor.line)}).groupBy(function(a){return(a.anchor.fileType||"")+a.anchor.line}).value()}(e),function(c){var d=c[0].anchor;(d=b.getLineHandle({fileType:d.fileType,lineType:d.lineType,lineNumber:d.line}))&&a.addCommentContainerForLine(d,
c)})},onFileCommentsResized:function(){this.trigger("fileCommentsResized")},onDiffChange:function(a){if("INITIAL"===a.type||"INSERT"===a.type){"INITIAL"===a.type&&this.addAnchoredComments();var b=this.diffView,e=this;a.eachLine(function(d){var g=d.line;var h=!d.attributes.expanded&&"MARKER"!==d.line.conflictMarker&&e.options.allowCommenting&&"INITIAL"===a.type?bitbucket.internal.feature.addCommentTrigger():bitbucket.internal.feature.dummyCommentTrigger({relevantContextLines:e.options.relevantContextLines});
d.handles.FROM&&b.setGutterMarker(d.handles.FROM,e.getGutterId(),(0,f.default)(h)[0]);d.handles.TO&&d.handles.FROM!==d.handles.TO&&b.setGutterMarker(d.handles.TO,e.getGutterId(),(0,f.default)(h)[0]);g.commentIds&&(g=c.default.chain(g.commentIds).map(k.default.lookup(e._commentsById)).filter(c.default.identity).value(),g.length&&e.addCommentContainerForLine(d.handles.FROM||d.handles.TO,g));e.unrestoredDrafts.length&&"INITIAL"===a.type&&c.default.chain(d.handles).values().compact().uniq().forEach(e.restoreDraftsForLine.bind(e)).value()})}},
onCommentContainerDestroyed:function(a){var b=this._getFileCommentContainer();b&&a===b.$el&&c.default.defer(this.onFileCommentsResized.bind(this))},onDiffViewOptionsChange:function(a){"hideComments"===a.key&&this.toggleComments(!a.value)},restoreDraftsForLine:function(a){var b=f.default.extend({line:a.lineNumber,lineType:a.lineType},{fileType:a.fileType});b=this.getUnrestoredDraftsForLine(b);b.length&&(a=this.addCommentContainerForLine(a),this._restoreDraftsToContainer(a,b),a.destroyIfEmpty())},_restoreDraftsToContainer:function(a,
b){c.default.forEach(b,a.restoreDraftComment.bind(a));this.unrestoredDrafts=c.default.difference(this.unrestoredDrafts,b)},restoreDrafts:function(){var a=this;this.options.allowCommenting||(this.unrestoredDrafts=c.default.filter(this.unrestoredDrafts,function(b){return(b.id||b.parent)&&(a.$el.is(".file-comment-activity")||b.anchor.line)}));this.restoreDraftFileComments()},restoreDraftFileComments:function(){var a=c.default.reject(this.unrestoredDrafts,k.default.dot("anchor.line"));a.length&&this._restoreDraftsToContainer(this.addCommentContainerForFile(),
a)},getUnrestoredDraftsForLine:function(a){var b=c.default.flow(this.unifyAnchorFileTypes,k.default.partialRight(c.default.pick,"fileType","line","lineType"));a=c.default.isEqual.bind(c.default,b(a));b=c.default.flow(k.default.dot("anchor"),b,a);return c.default.filter(this.unrestoredDrafts,b)},unifyAnchorFileTypes:function(a){var b=a.lineType===n.default.ADDED&&a.fileType===t.default.TO;return(a.lineType===n.default.CONTEXT||a.lineType===n.default.REMOVED)&&a.fileType===t.default.FROM||b?c.default.omit(a,
"fileType"):a},clarifyAmbiguousDraftProps:function(a){a=h.default.prototype.clarifyAmbiguousDraftProps.call(this,a);a.anchor=this.unifyAnchorFileTypes(a.anchor);return a},setDiffView:function(a){this.diffView&&this.diffView.off("internal-change",this.onDiffChange);if(this.diffView=a)this.diffView.on("internal-change",this.onDiffChange),this._destroyables.push({destroy:q.default.bind("addFileComment",this.addFileCommentClicked.bind(this))}),this._destroyables.push({destroy:q.default.bind("requestTertiaryNext",
a._scrollToComment.bind(a,u.default.DOWN))}),this._destroyables.push({destroy:q.default.bind("requestTertiaryPrevious",a._scrollToComment.bind(a,u.default.UP))})},toggleComments:function(a){this.$el.toggleClass("hide-comments",!a);c.default.invokeMap(this._containers,"toggleComment",a)}});v.exports=l["default"]});