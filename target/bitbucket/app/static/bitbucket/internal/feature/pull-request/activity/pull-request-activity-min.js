define("bitbucket/internal/feature/pull-request/activity/pull-request-activity","module exports @atlassian/aui jquery lodash bitbucket/util/navbuilder bitbucket/internal/enums bitbucket/internal/feature/comments/comments bitbucket/internal/feature/file-content/file-content bitbucket/internal/model/commit-range bitbucket/internal/model/diff-type bitbucket/internal/model/file-change bitbucket/internal/model/file-content-modes bitbucket/internal/model/page-state bitbucket/internal/model/path bitbucket/internal/model/path-and-line bitbucket/internal/model/revision bitbucket/internal/util/ajax bitbucket/internal/util/client-storage bitbucket/internal/util/codemirror bitbucket/internal/util/dom-event bitbucket/internal/util/events bitbucket/internal/util/history bitbucket/internal/util/scroll bitbucket/internal/util/syntax-highlight bitbucket/internal/util/time-i18n-mappings bitbucket/internal/widget/paged-scrollable".split(" "),
function(M,y,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,aa,ba,ca,da,ea,fa,ha,ia,ja,ka,la,ma){function na(a){(this.execute?this:m.default.whenIType(a)).execute(function(){var a=(0,k.default)(".general-comment-form");D.default.scrollTo(a);a.find("textarea").focus()})}function oa(a){a.closest(".diff-comment-activity, .file-comment-activity").remove()}function E(a){var c=a.getPath();return(a=a.getDiff().hunks[0])?0!==a.sourceLine?new z.default(c,a.sourceLine,"FROM"):new z.default(c,a.destinationLine,"TO"):new z.default(c)}
function F(a,c){var b=n.default.currentPullRequest();a.commentAnchor&&a.commentAnchor&&(a.commentAnchor.diffType===pa||a.commentAnchor.diffType===G)?(b=b.commit(a.commentAnchor.toHash),c&&(b=b.change(E(c).toString())),a.commentAnchor.diffType===G&&(b=b.withParams({since:a.commentAnchor.fromHash}))):a.commentAnchor&&(a=c?E(c).toString():new H.default(a.commentAnchor.path),b=b.diff().change(a));return b.build()}function e(a,c,b,d,f){this._$container=(0,k.default)(a);this.pullRequest=c;this.pullRequestPathComponents=
{projectKey:l.default.getProject().getKey(),repoSlug:l.default.getRepository().getSlug(),pullRequestId:this.pullRequest.getId()};this.fromType=b;this.fromId=d;this.dataLoadedEvent="bitbucket.internal.feature.pullRequestActivity.dataLoaded";this._$spinner=(0,k.default)('\x3cdiv class\x3d"spinner"/\x3e').insertAfter(this._$container);w.default.call(this,f.scrollableElement||a,{pageSize:25,dataLoadedEvent:this.dataLoadedEvent,autoLoad:"next",paginationContext:"pull-request-activity"})}Object.defineProperty(y,
"__esModule",{value:!0});var m=babelHelpers.interopRequireDefault(N),k=babelHelpers.interopRequireDefault(O),h=babelHelpers.interopRequireDefault(P),n=babelHelpers.interopRequireDefault(Q),A=babelHelpers.interopRequireDefault(R),r=babelHelpers.interopRequireDefault(S),I=babelHelpers.interopRequireDefault(T),x=babelHelpers.interopRequireDefault(U),u=babelHelpers.interopRequireDefault(V),B=babelHelpers.interopRequireDefault(W),qa=babelHelpers.interopRequireDefault(X),l=babelHelpers.interopRequireDefault(Y),
H=babelHelpers.interopRequireDefault(Z),z=babelHelpers.interopRequireDefault(aa),t=babelHelpers.interopRequireDefault(ba),J=babelHelpers.interopRequireDefault(ca),C=babelHelpers.interopRequireDefault(da),ra=babelHelpers.interopRequireDefault(ea),p=babelHelpers.interopRequireDefault(ha),sa=babelHelpers.interopRequireDefault(ia),D=babelHelpers.interopRequireDefault(ja),ta=babelHelpers.interopRequireDefault(ka),K=babelHelpers.interopRequireDefault(la),w=babelHelpers.interopRequireDefault(ma),ua=u.default.EFFECTIVE,
pa=u.default.COMMIT,G=u.default.RANGE;k.default.extend(e.prototype,w.default.prototype);e.prototype.init=function(a){this.renderedDiffFileContents=[];w.default.prototype.init.call(this,a);this._inited=!0;this.loadedRange.isEmpty()||(this.renderedDiffFileContents=this.renderedDiffFileContents.concat(e.renderDiffs(this._$container.children(".diff-comment-activity"),a.diffCommentData,this.pullRequest)));r.default.bindContext(this._$container,new r.default.PullRequestAnchor(this.pullRequest));var c=this;
this._reviewerSelfHandler=function(b){var a="ADD_SELF"===b.action;c.addNewActivity({currentUser:l.default.getCurrentUser().toJSON(),pullRequest:b.pullRequest,isNew:!0,activity:{action:"UPDATED",createdDate:new Date,user:b.user,addedReviewers:a?[b.user]:[],removedReviewers:a?[]:[b.user]}})};this._reviewerStatusHandler=function(a){a.oldState===A.default.ApprovalStatus.NEEDS_WORK&&a.newState===A.default.ApprovalStatus.UNAPPROVED||c.addNewActivity({currentUser:l.default.getCurrentUser().toJSON(),pullRequest:a.pullRequest,
activity:{action:a.newState===A.default.ApprovalStatus.NEEDS_WORK?"REVIEWED":a.newState,createdDate:new Date,user:a.user}})};this._declineHandler=function(a){c.addNewActivity({currentUser:l.default.getCurrentUser().toJSON(),pullRequest:a.pullRequest,activity:{action:"DECLINED",createdDate:a.pullRequest.updatedDate,user:a.user}})};this._pushStateIfDiffOrCommitUrl=function(a){var b=(0,k.default)(a.target).prop("href");(h.default.startsWith(b,n.default.currentPullRequest().diff().buildAbsolute())||h.default.startsWith(b,
n.default.currentPullRequest().commit("").buildAbsolute()+"/"))&&(0,fa.openInSameTab)(a)&&(a.preventDefault(),window.scrollTo(0,0),sa.default.pushState(null,"",b))};this._mergeHandler=function(a){c.addNewActivity({currentUser:l.default.getCurrentUser().toJSON(),pullRequest:a.pullRequest,activity:{action:"MERGED",createdDate:a.pullRequest.updatedDate,user:a.user,simpleMerge:!0,commit:a.pullRequest.properties.mergeCommit}})};this._reopenedHandler=function(a){c.addNewActivity({currentUser:l.default.getCurrentUser().toJSON(),
pullRequest:a.pullRequest,activity:{action:"REOPENED",createdDate:a.pullRequest.updatedDate,user:a.user}})};this._destroyables=[];this._destroyables.push(p.default.chainWith((0,k.default)(document)).on("click",".pull-request-activity .activity-item a",this._pushStateIfDiffOrCommitUrl).on("click",".diff-comment-activity .breadcrumbs a,.rescope a.commitid,.actions button.delete,.comment-likes-button",function(a){var b,f=a.target.classList;f.contains("stub")?b="overview.comment.open":f.contains("commitid")?
b="overview.commit.open":f.contains("delete")?b="overview.comment.delete.clicked":f.contains("comment-likes-button")&&(b="overview.comment.like.clicked");(0,k.default)(a.target).closest("#pull-request-activity")&&p.default.trigger("bitbucket.internal.feature.pullRequest."+b)}));this._destroyables.push(p.default.chain().on("bitbucket.internal.feature.pullRequest.reopened",this._reopenedHandler).on("bitbucket.internal.feature.pullRequest.declined",this._declineHandler).on("bitbucket.internal.feature.pullRequest.merged",
this._mergeHandler).on("bitbucket.internal.feature.pullRequest.reviewerStatus.changed",this._reviewerStatusHandler).on("bitbucket.internal.feature.comments.lastCommentDeleted",oa).on("bitbucket.internal.keyboard.shortcuts.pullrequest.addCommentHandler",na).on("bitbucket.internal.feature.pullRequest.self.added",this._reviewerSelfHandler).on("bitbucket.internal.feature.pullRequest.self.removed",this._reviewerSelfHandler))};e.prototype.reset=function(){h.default.invokeMap(this._destroyables,"destroy");
h.default.chain(this.renderedDiffFileContents).map("inlineInfo").map("fileContent").invokeMap("destroy").value();delete this.renderedDiffFileContents;h.default.invokeMap(this.fileCommentContexts,"destroy");delete this.fileCommentContexts;r.default.unbindContext(this._$container);w.default.prototype.reset.call(this);this.currentTime=void 0;this._inited=!1};e.prototype.checkCommentIsNew=function(a){a.isUnread=a.updatedDate>this.lastViewed&&(!l.default.getCurrentUser()||a.author.name!==l.default.getCurrentUser().getName());
a.comments.length&&h.default.forEach(a.comments,h.default.bind(this.checkCommentIsNew,this))};e.prototype.checkCommentActivitiesAreNew=function(a){var c=this;h.default.forEach(h.default.filter(a,{action:"COMMENTED"}),function(a){c.checkCommentIsNew(a.comment)})};e.prototype.requestData=function(a,c){var b=this,d=0!==a||h.default.isUndefined(this.fromType)||h.default.isUndefined(this.fromId)?{}:{fromType:this.fromType,fromId:this.fromId};this._$spinner.spin("large");return J.default.rest({url:n.default.rest().project(this.pullRequestPathComponents.projectKey).repo(this.pullRequestPathComponents.repoSlug).pullRequest(this.pullRequestPathComponents.pullRequestId).activities().withParams(k.default.extend(d,
{start:a,limit:c,avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"medium"}),markup:!0})).build(),statusCode:{404:function(a,g,c,d,e){(a=h.default.get(d,"errors.0",null))&&"com.atlassian.bitbucket.commit.NoSuchCommitException"===a.exceptionName?a={canClose:!0,fallbackTitle:m.default.I18n.getText("bitbucket.web.ajax.back.to.dashboard"),fallbackUrl:n.default.dashboard().build(),message:a.message,shouldReload:!1,title:m.default.I18n.getText("bitbucket.web.couldnt.find.title")}:(a={canClose:!1,
fallbackTitle:m.default.I18n.getText("bitbucket.web.pullrequest.activity.notfound.fallback.title"),fallbackUrl:n.default.project(b.pullRequestPathComponents.projectKey).repo(b.pullRequestPathComponents.repoSlug).pullRequest(b.pullRequestPathComponents.pullRequestId).overview().build(),shouldReload:!1},"activity"===b.fromType?(a.message=m.default.I18n.getText("bitbucket.web.pullrequest.activity.notfound.message"),a.title=m.default.I18n.getText("bitbucket.web.pullrequest.activity.notfound.title")):
(a.message=m.default.I18n.getText("bitbucket.web.pullrequest.comment.notfound.message"),a.title=m.default.I18n.getText("bitbucket.web.pullrequest.comment.notfound.title")));return babelHelpers.extends({},e,a)}}}).done(function(a,g,c){b.currentTime||(g=(new Date(c.getResponseHeader("Date"))).getTime(),c=C.default.buildKey("last-viewed","pull-request"),b.currentTime=isNaN(g)?(new Date).getTime():g,b.lastViewed=C.default.getItem(c)||b.currentTime,C.default.setItem(c,b.currentTime));b.checkCommentActivitiesAreNew(a.values)}).fail(function(){b._$spinner.spinStop()})};
e.prototype.attachContent=function(a,c){this._$container["html"===a?"append":a](c)};e.prototype.decorateForFocus=function(a){var c;if("activity"===this.fromType){var b=parseInt(this.fromId,10);h.default.some(a.values,function(a,f){return a.id===b?(a.isFocused=!0,c=b,!0):!1})}else{var d=parseInt(this.fromId,10),f=function v(a){return a.id===d?a.isFocused=!0:a.comments?h.default.some(a.comments,function(a){return v(a)}):!1};h.default.some(a.values,function(a,b){return a.comment&&f(a.comment)?(c=a.id,
!0):!1})}return c};e.prototype.onAttachFirstPermalinkPage=function(a,c){function b(){g.hide();v.spin("large");var a=d.loadedRange.pageBefore(d.options.pageSize);J.default.rest({url:n.default.rest().project(d.pullRequestPathComponents.projectKey).repo(d.pullRequestPathComponents.repoSlug).pullRequest(d.pullRequestPathComponents.pullRequestId).activities().withParams(k.default.extend(a,{avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"medium"}),markup:!0})).build()}).done(function(a,b,c){d.loadedRange.add(a.start,
a.size,a.isLastPage,a.nextPageStart);var k;h.default.some(a.values,function(a,b){if(a.id===L)return k=b,!0});b=a.values.slice(0,k);d.checkCommentActivitiesAreNew(b);d.attachActivities(b,function(a){f.after(a)});a.isFirstPage||d.loadedRange.reachedStart()?(g.unbind("click"),f.remove(),v.remove()):(L=e,e=a.previousPageStartId);p.default.trigger(d.dataLoadedEvent,d,a.start,a.limit,a)}).always(function(){v.spinStop();g.show()})}var d=this,f=(0,k.default)(bitbucket.internal.feature.pullRequest.loadPreviousActivities());
this.attachContent(c,f);var g=f.find("a"),v=f.append((0,k.default)('\x3cdiv class\x3d"spinner"/\x3e')),e=a.previousPageStartId,L=a.values[0].id;g.click(function(a){a.preventDefault();b()})};e.prototype.attachActivities=function(a,c){var b=this,d=0,f=(0,k.default)(h.default.map(a,function(a){var c=a.commentAnchor;c=c?new x.default({diffType:c.diffType,pullRequest:b.pullRequest,untilRevision:new t.default({id:c.toHash}),sinceRevision:c.fromHash?new t.default({id:c.fromHash}):void 0}):new x.default({pullRequest:b.pullRequest,
diffType:ua});var f=void 0;"COMMENTED"===a.action&&(f=c.getPullRequest().getToRef().getRepository(),c=a.diff?B.default.fromDiff(a.diff,c,f):null,f=F(a,c));a=bitbucket.internal.feature.pullRequest.activityListItem({activity:a,pullRequest:b.pullRequest.toJSON(),isNew:!1,commitId:a.commentAnchor&&a.commentAnchor.toHash,commentLink:f,customMapping:K.default.commentEditedAge});d++;return a}).join(""));ta.default.container(f);a=h.default.reduce(a,function(a,b){a[b.id]=b;return a},{});c(f);this.fileCommentContexts=
e.addBreadcrumbsAndBindFileComments(f.filter(".file-comment-activity"),a,this.pullRequest);c=e.renderDiffs(f.filter(".diff-comment-activity"),a,this.pullRequest);this.renderedDiffFileContents=this.renderedDiffFileContents.concat(c);this._$container.find(".pull-request-diff-outdated-lozenge").tooltip({gravity:"ne"});this._$container.find(".reviewers-updated-activity .aui-avatar img").tooltip({gravity:"n"});return c};e.prototype.attachNewContent=function(a,c){function b(a){if(d._inited)if(a=e?(0,k.default)(".comment.focused",
a):(0,k.default)(".activity-item.focused",a),a.length)D.default.scrollTo(a,{waitForImages:!0,cancelIfScrolled:!0,duration:400}),p.default.trigger("bitbucket.internal.feature.pullRequestActivity.focused",null,a);else if(e)p.default.once("bitbucket.internal.feature.comments.commentContainerAdded",b)}var d=this,f=(0,k.default)("#pull-request-activity \x3e li.comment-form-container"),g=!h.default.isUndefined(this.fromId)&&!h.default.isUndefined(this.fromType),e="comment"===this.fromType;f=0===f.siblings().length;
var l;g&&f&&(l=this.decorateForFocus(a));if(g&&!a.isFirstPage&&f)this.onAttachFirstPermalinkPage(a,c);g=this.attachActivities(a.values,function(a){d.attachContent(c,a)});this._$spinner.spinStop();a.isLastPage&&this._$spinner.remove();null!=l&&((a=h.default.find(g,{activityId:l}))?a.inlineInfo.initPromise.done(b.bind(null,null)):b())};e.renderDiffForComment=function(a,c,b){var d=c.commentAnchor;a=new I.default(a);var f=b.getToRef().getRepository(),g=!d.orphaned,e=d.diffType;b=new x.default({diffType:d.diffType,
pullRequest:b,untilRevision:new t.default({id:d.toHash}),sinceRevision:d.fromHash?new t.default({id:d.fromHash}):void 0});b=B.default.fromDiff(c.diff,b,f);c=a.init(b,{commentMode:I.default.commentMode.REPLY_ONLY,lineComments:[c.comment],asyncDiffModifications:!1,attachScroll:!1,autoResizing:!0,scrollStyle:"inline",isExcerpt:!0,contentMode:qa.default.DIFF,changeTypeLozenge:!1,changeModeLozenge:!1,fileIcon:!0,breadcrumbs:!0,scrollPaneSelector:"self",pullRequestDiffLink:!0,pullRequestDiffCurrent:g,diffType:e,
pullRequestDiffLinkUrl:F(c,b),toolbarWebFragmentLocationPrimary:"bitbucket.pull-request.activity.diff.toolbar.primary",toolbarWebFragmentLocationSecondary:"bitbucket.pull-request.activity.diff.toolbar.secondary"});return{fileContent:a,initPromise:c}};e.renderDiffs=function(a,c,b){var d=[];h.default.forEach(a,function(a){var b=Number(a.getAttribute("data-activityid"));d.push({activityId:b,el:a,data:c[b]})});return ra.default.doInOperation(function(){return h.default.map(d,function(a){return{activityId:a.activityId,
inlineInfo:e.renderDiffForComment((0,k.default)(a.el).find(".detail"),a.data,b)}})})};e.addBreadcrumbsAndBindFileComments=function(a,c,b){var d=[];a.each(function(){var a=(0,k.default)(this),g=a.attr("data-activityid");g=c[g].commentAnchor;var e=new H.default(g.path),m=!(g&&g.orphaned),p=h.default.map(e.getComponents(),function(a){return{text:a}}),q=n.default.currentPullRequest();switch(g.diffType){case u.default.COMMIT:q=q.commit(g.toHash);break;case u.default.RANGE:q=q.commit(g.toHash).since(g.fromHash);
break;default:q=q.diff()}a.find(".breadcrumbs").append(bitbucket.internal.widget.breadcrumbs.crumbs({pathComponents:p,primaryLink:m?q.change(e).build():void 0}));g=new B.default({repository:l.default.getRepository(),commitRange:new x.default({diffType:g.diffType,pullRequest:b,untilRevision:new t.default({id:g.toHash}),sinceRevision:g.fromHash?new t.default({id:g.fromHash}):void 0}),path:e});a=r.default.bindContext(a,new r.default.DiffAnchor(g),{$toolbar:a.find(".file-toolbar"),commentMode:r.default.commentMode.REPLY_ONLY});
d.push(a)});return d};e.prototype.addNewActivity=function(a){var c=(0,k.default)("#pull-request-activity .comment-form-container").first(),b=(0,k.default)(bitbucket.internal.feature.pullRequest.activityListItem({currentUser:a.currentUser.name?a.currentUser:a.currentUser.toJSON(),activity:a.activity,pullRequest:a.pullRequest.id?a.pullRequest:a.pullRequest.toJSON(),isNew:!0,customMapping:K.default.commentEditedAge})).hide().insertAfter(c).fadeIn("slow");setTimeout(function(){b.removeClass("new")},3E3)};
e.prototype.handleErrors=k.default.noop;y.default=e;M.exports=y["default"]});