define("bitbucket/internal/feature/pull-request/header/pull-request-header-view","module exports @atlassian/aui jquery lodash prop-types react react-redux bitbucket/util/navbuilder bitbucket/internal/bbui/aui-react/avatar bitbucket/internal/bbui/pull-request-header/pull-request-header bitbucket/internal/enums bitbucket/internal/feature/pull-request/action-creators/can-merge bitbucket/internal/feature/pull-request/action-creators/change-reviewer-status bitbucket/internal/feature/pull-request/action-creators/change-self-reviewer bitbucket/internal/feature/pull-request/action-creators/watch bitbucket/internal/feature/pull-request/edit/pull-request-edit bitbucket/internal/feature/pull-request/merge-dialog/merge-dialog bitbucket/internal/model/page-state bitbucket/internal/model/participant bitbucket/internal/model/pull-request-json bitbucket/internal/util/ajax bitbucket/internal/util/events bitbucket/internal/util/set-dialog-buttons-disabled bitbucket/internal/util/shortcuts bitbucket/internal/widget/submit-spinner/submit-spinner".split(" "),
function(B,q,e,k,l,C,m,D,E,w,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U){function V(){function f(a){var c=a.approved?e.I18n.getText("bitbucket.web.pullrequest.toolbar.approved.updateflag"):e.I18n.getText("bitbucket.web.pullrequest.toolbar.unapproved.updateflag");b(c,a)}function d(a){var c=a.watchState?e.I18n.getText("bitbucket.web.watchable.watched.tooltip"):e.I18n.getText("bitbucket.web.watchable.unwatched.tooltip");b(c,a)}function b(c,W){(0,l.isMatch)(W,r)&&(a&&a.close(),a=(0,e.flag)({type:"success",title:c,
close:"auto"}))}var a=void 0;g.default.on("bitbucket.internal.widget.approve-button.added",f);g.default.on("bitbucket.internal.widget.approve-button.removed",f);g.default.on("bitbucket.internal.web.watch-button.added",d);g.default.on("bitbucket.internal.web.watch-button.removed",d)}function x(f){var d=(0,e.dialog2)(f.templates.dialog()),b=void 0;d.$el.on("click",".confirm-button",function(a){var c=new X.default(a.target,"before");(0,y.default)(d,!0);c.show();b=z.default.rest(f.ajax);b.fail(function(a,
c,b,e){400===a.status?(a=d.$el.find(".aui-dialog2-content"),e.errors&&(a.children(".aui-message").remove(),a.prepend(f.templates.error(e.errors)))):d.hide()}).always(function(){c.hide();(0,y.default)(d,!1);b=null}).done(function(a){g.default.trigger(f.events.done,null,{user:h.default.getCurrentUser().toJSON(),pullRequest:a});f.callback(a)})});d.$el.find(".cancel-button").on("click",function(){b&&(b.abort(),b=null);d.hide()});d.$el.on("aui-show",Y.default.debounce(function(){return d.$el.find(".cancel-button").focus()}));
return d}function t(e,d,b){h.default.getPullRequest().set((0,P.filter)(e));!0===d&&b.dispatch({type:"PR_SET_PULL_REQUEST",payload:e})}Object.defineProperty(q,"__esModule",{value:!0});var Z=babelHelpers.interopRequireDefault(k),Y=babelHelpers.interopRequireDefault(l);k=babelHelpers.interopRequireDefault(C);var aa=babelHelpers.interopRequireDefault(m),p=babelHelpers.interopRequireDefault(E),ba=babelHelpers.interopRequireDefault(F),n=babelHelpers.interopRequireDefault(G),ca=babelHelpers.interopRequireDefault(H),
da=babelHelpers.interopRequireDefault(I),ea=babelHelpers.interopRequireDefault(J),u=babelHelpers.interopRequireDefault(K),fa=babelHelpers.interopRequireDefault(L),A=babelHelpers.interopRequireDefault(M),h=babelHelpers.interopRequireDefault(N),ha=babelHelpers.interopRequireDefault(O),z=babelHelpers.interopRequireDefault(Q),g=babelHelpers.interopRequireDefault(R),y=babelHelpers.interopRequireDefault(S),v=babelHelpers.interopRequireDefault(T),X=babelHelpers.interopRequireDefault(U),r={triggeredBy:"keyboardShortcut"};
m=function(f){function d(b){babelHelpers.classCallCheck(this,d);var a=babelHelpers.possibleConstructorReturn(this,(d.__proto__||Object.getPrototypeOf(d)).call(this,b));a.onMoreAction=function(c){switch(c){case "edit":a._pullRequestEdit.show();break;case "watch":a.toggleWatch();break;case "decline":a.declineDialog||a.createDeclineDialog();a.declineDialog.show();break;case "delete":a.deleteDialog||a.createDeleteDialog(),a.deleteDialog.show()}};a.onReOpenClick=function(){var c=p.default.rest().currentPullRequest().reopen().withParams({avatarSize:w.AvatarSize.XSMALL,
version:h.default.getPullRequest().getVersion()}).build();return z.default.rest({url:c,type:"POST",statusCode:{409:function(a,c,b,d,f){return babelHelpers.extends({},f,{title:e.I18n.getText("bitbucket.web.pullrequest.reopened.error.409.title"),fallbackUrl:!1,shouldReload:!1})}}}).done(function(c){g.default.trigger("bitbucket.internal.feature.pullRequest.reopened",null,{user:h.default.getCurrentUser().toJSON(),pullRequest:c});t(c,!0,a.props);a.mergeCheck()})};a.onSelfClick=function(c,b){a.props.dispatch((0,
ea.default)(a.props.pullRequest,a.props.currentUser,c,a.props.currentUserAsReviewer&&a.props.currentUserAsReviewer.status));"ADD_SELF"===c&&a.props.dispatch((0,u.default)({stateOnly:!0,watchState:!0}));b&&a.props.dispatch((0,u.default)({watchState:!1}))};a.onStatusClick=function(c){var b=a.props,d=b.dispatch,e=b.currentUser,f=b.currentUserAsReviewer;b=b.pullRequest;f?d((0,da.default)((0,l.merge)({pullRequest:b,user:e,oldStatus:f.status},c))):console.warn("Current user is not a reviewer")};a.onMergeHelpDialogClose=
function(){a.setState({showMergeHelpDialog:!1})};a.getConditions=function(){var c=a.props,b=c.hasSourceRepoRead,d=c.pullRequest.author.user.name===c.currentUser.name,e=c.hasRepoWrite;d=e||d;return{canMerge:e,canDecline:d,canDelete:c.canDelete,canEdit:d,canReOpen:d&&b,canUpdateSourceBranch:c.hasSourceRepoWrite}};a.toggleWatch=function(c){var b=a.props,d=b.dispatch;b=b.pullRequest;d((0,u.default)((0,l.merge)({},{watchState:!b.isWatching},c)))};a.mergeCheck=function(){var c=a.props,b=c.dispatch;c=c.pullRequest;
c.state===n.default.PullRequestState.OPEN&&b((0,ca.default)(c,a.props.mergeTimeout))};a.initMergeEvents=function(){g.default.on("bitbucket.internal.feature.pull-request.merge-check",a.mergeCheck);["bitbucket.internal.feature.pullRequest.reviewerStatus.changed","bitbucket.internal.feature.pullRequest.self.added","bitbucket.internal.feature.pullRequest.self.removed"].forEach(function(c){return g.default.on(c,a.mergeCheck)});g.default.on("bitbucket.internal.branch.plugin.conflict.merge.help",function(c){return a.setState({mergeHelp:c})});
g.default.on("bitbucket.internal.pull-request.show.cant.merge.help",function(){return a.setState({showMergeHelpDialog:!0})})};a.createDeclineDialog=function(){a.declineDialog=x({buttonSelector:".decline-pull-request",ajax:{url:p.default.rest().currentPullRequest().decline().withParams({avatarSize:w.AvatarSize.XSMALL,version:h.default.getPullRequest().getVersion()}).build(),type:"POST",statusCode:{401:function(a,b,d,f,g){return babelHelpers.extends({},g,{title:e.I18n.getText("bitbucket.web.pullrequest.decline.error.401.title"),
message:e.I18n.getText("bitbucket.web.pullrequest.decline.error.401.message"),fallbackUrl:!1,shouldReload:!0})}}},callback:function(c){t(c,!0,a.props);a.declineDialog.hide()},templates:{dialog:function(){return bitbucket.internal.feature.pullRequest.decline.dialog({content:'\x3cp class\x3d"decline-message"\x3e\n                        '+e.I18n.getText("bitbucket.web.pullrequest.decline.dialog.message")+"\n                    \x3c/p\x3e"})},error:function(a){return bitbucket.internal.feature.pullRequest.decline.errors({errors:a})}},
events:{done:"bitbucket.internal.feature.pullRequest.declined"}})};a.createDeleteDialog=function(){a.deleteDialog=x({buttonSelector:".delete-pull-request",ajax:{url:p.default.rest().currentPullRequest().build(),type:"DELETE",data:{version:h.default.getPullRequest().getVersion()},statusCode:{400:!1,401:function(a,b,d,f,g){return babelHelpers.extends({},g,{title:e.I18n.getText("bitbucket.web.pullrequest.delete.error.401.title"),message:e.I18n.getText("bitbucket.web.pullrequest.delete.error.401.message"),
fallbackUrl:!1,shouldReload:!0})}}},callback:function(){a.deleteDialog.hide();window.location=p.default.currentRepo().allPullRequests().build()},templates:{dialog:function(){return bitbucket.internal.feature.pullRequest.delete.dialog({content:'\x3cp class\x3d"delete-message"\x3e\n                        '+e.I18n.getText("bitbucket.web.pullrequest.delete.dialog.message")+"\n                    \x3c/p\x3e"})},error:function(a){return bitbucket.internal.feature.pullRequest.delete.errors({errors:a})}},
events:{done:"bitbucket.internal.feature.pullRequest.deleted"}})};a.state={};return a}babelHelpers.inherits(d,f);babelHelpers.createClass(d,[{key:"componentDidMount",value:function(){var b=this,a=h.default.getPullRequest();this._pullRequestEdit=new fa.default(a);v.default.bind("pullRequestApprove",function(){var a=(b.props.currentUserAsReviewer&&b.props.currentUserAsReviewer.status)===n.default.ApprovalStatus.APPROVED?n.default.ApprovalStatus.UNAPPROVED:n.default.ApprovalStatus.APPROVED;b.onStatusClick((0,
l.merge)({newStatus:a},r))});v.default.bind("pullRequestEdit",function(){a.getState()!==n.default.PullRequestState.MERGED&&b._pullRequestEdit.show()});(0,Z.default)(document).on("click",".add-description",function(){b._pullRequestEdit.show()});v.default.bind("pullRequestWatch",function(){b.toggleWatch(r)});g.default.once("bitbucket.internal.feature.comments.commentAdded",function(){var c=h.default.getCurrentUser(),d=a.getParticipants().toJSON();[a.getAuthor().toJSON()].concat(a.getReviewers().toJSON()).concat(d).some(function(a){return a.user.name===
c.id})||(a.setParticipants(d.concat([new ha.default({user:c})])),b.toggleWatch({watchState:!0}))});this.mergeCheck();A.default.initMergeDialog({callback:function(a){return t(a,!0,b.props)},mergeTimeout:this.props.mergeTimeout});this.initMergeEvents();V()}},{key:"render",value:function(){var b={pullRequest:this.props.pullRequest,conditions:this.getConditions(),currentUser:this.props.currentUser,currentUserAsReviewer:this.props.currentUserAsReviewer,currentUserIsWatching:this.props.pullRequest.isWatching,
mergeHelp:this.state.mergeHelp,onMoreAction:this.onMoreAction,currentUserStatus:this.props.currentUserAsReviewer&&this.props.currentUserAsReviewer.status,onMergeClick:A.default.onMergeClick,onReOpenClick:this.onReOpenClick,onSelfClick:this.onSelfClick,onStatusClick:this.onStatusClick,permissionToReview:this.props.currentUser.name!==this.props.pullRequest.author.user.name,showMergeHelpDialog:this.state.showMergeHelpDialog,onMergeHelpDialogClose:this.onMergeHelpDialogClose};return aa.default.createElement(ba.default,
b)}}]);return d}(m.Component);m.propTypes={canDelete:k.default.bool.isRequired,hasRepoWrite:k.default.bool.isRequired,hasSourceRepoWrite:k.default.bool.isRequired,hasSourceRepoRead:k.default.bool.isRequired,mergeTimeout:k.default.number.isRequired};q.default=(0,D.connect)(function(e){var d=e.currentUser,b=e.pullRequest;return{pullRequest:b,currentUser:d,currentUserAsReviewer:function(){return(0,l.find)(b.reviewers,function(a){return a.user.name===d.name})}()}})(m);B.exports=q["default"]});