define("bitbucket/internal/feature/pull-request/diff/pull-request-diff","module exports @atlassian/aui chaperone jquery lodash bitbucket/util/navbuilder bitbucket/internal/feature/commit/tree-and-diff-view/tree-and-diff-view bitbucket/internal/feature/file-content/commit-selector/commit-selector bitbucket/internal/feature/file-content/diff-view-type bitbucket/internal/feature/file-content/request-change bitbucket/internal/feature/pull-request/pull-request-history/pull-request-history bitbucket/internal/layout/page-scrolling-manager bitbucket/internal/model/commit-range bitbucket/internal/model/diff-type bitbucket/internal/model/file-content-modes bitbucket/internal/model/path-and-line bitbucket/internal/model/revision bitbucket/internal/util/events bitbucket/internal/util/history".split(" "),
function(R,w,p,S,T,U,V,W,X,Y,Z,aa,ba,ca,da,ea,fa,ha,ia,ja){Object.defineProperty(w,"__esModule",{value:!0});var h=babelHelpers.interopRequireDefault(p),A=babelHelpers.interopRequireDefault(S),d=babelHelpers.interopRequireDefault(T),n=babelHelpers.interopRequireDefault(U),x=babelHelpers.interopRequireDefault(V),y=babelHelpers.interopRequireDefault(W),ka=babelHelpers.interopRequireDefault(X),z=babelHelpers.interopRequireDefault(Y),la=babelHelpers.interopRequireDefault(Z),I=babelHelpers.interopRequireDefault(aa),
ma=babelHelpers.interopRequireDefault(ba),B=babelHelpers.interopRequireDefault(ca);p=babelHelpers.interopRequireDefault(da);var na=babelHelpers.interopRequireDefault(ea),oa=babelHelpers.interopRequireDefault(fa),J=babelHelpers.interopRequireDefault(ha),t=babelHelpers.interopRequireDefault(ia),C=babelHelpers.interopRequireDefault(ja),F=p.default.EFFECTIVE,K=p.default.COMMIT,pa=p.default.RANGE,l=[],D=null,G=void 0,H=function(){null!==D&&(D.destroy(),D=null)},m=function(a){return x.default.project(a.getToRef().getRepository().getProject()).repo(a.getToRef().getRepository()).pullRequest(a)},
u=function(a){return x.default.rest().project(a.getToRef().getRepository().getProject()).repo(a.getToRef().getRepository()).pullRequest(a)},qa=function(a){return function(c){var g=c.commitRange;return u(a).diff(c).withParams({diffType:g.diffType,sinceId:g.sinceRevision.id,untilId:g.untilRevision.id})}},L=function(a){var c=a.commit,g=a.since;return m(a.pullRequest).commit(c).since(g)},ra=function(a){return function(c){return u(a).diff(c)}},ta=function(a){var c=a.commit,g=a.commitRange,k=a.pullRequest,
d=a.lastReviewedCommit,b=a.unreviewedCommits;a=a.includesMerge;var v=[{href:m(k).diff().build(),icon:bitbucket.internal.feature.fileContent.allCommitsIcon(),messageHtml:h.default.escapeHtml(h.default.I18n.getText("bitbucket.web.diff.all.changes.displayed")),selected:!c&&!g}];d&&(b?(!a&&sa(),v.push({commitRange:{sinceRevision:{id:d},untilRevision:{id:k.getFromRef().getLatestCommit()}},href:L({pullRequest:k,commit:k.getFromRef().getLatestCommit(),since:d}).build(),icon:bitbucket.internal.feature.fileContent.singleCommitIcon(),
messageHtml:bitbucket.internal.feature.pullRequest.commitSelectorUnreviewedCommits({unreviewedCommits:b,includesMerge:a}),size:a?"large":"small",selected:!c&&g&&g.getSinceRevision().getId()===d&&g.getUntilRevision().getId()===k.getFromRef().getLatestCommit()})):d===k.getFromRef().getLatestCommit()&&v.push({disabled:!0,href:"",messageHtml:h.default.escapeHtml(h.default.I18n.getText("bitbucket.web.diff.no.unreviewed.changes")),selected:!1}));return v},ua=function(a,c,d,h,n){var b=c&&c.getDiffType()||
a&&K||F,g=u(d).comments(),k=void 0,l=void 0,m=void 0,q=void 0;b===F?(k=ra(d),l="bitbucket.pull-request.diff.toolbar.primary",m="bitbucket.pull-request.diff.toolbar.secondary",q=z.default.EFFECTIVE):(k=qa(d),l="bitbucket.pull-request.commit.diff.toolbar.primary",m="bitbucket.pull-request.commit.diff.toolbar.secondary",q=z.default.COMMON_ANCESTOR,g=b===pa?g.range(c.getSinceRevision().getId(),c.getUntilRevision().getId()):g.commit(a));return{changesUrlBuilder:function(a,b,d){return x.default.rest().currentRepo().changes(d).withParams({start:a,
limit:b})},commentMode:y.default.commentMode.CREATE_NEW,commentUrlBuilder:function(){return g},diffUrlBuilder:k,linkToCommit:!!a,maxChanges:h,relevantContextLines:n,toolbarWebFragmentLocationPrimary:l,toolbarWebFragmentLocationSecondary:m,diffViewType:q}},sa=n.default.once(function(){A.default.registerFeature("iterative-review",[{id:"iterative-review",alignment:"right top",selector:".file-tree-container .commit-selector-button",title:h.default.I18n.getText("bitbucket.web.pullrequest.iterativereview.discovery.main.title"),
content:h.default.I18n.getText("bitbucket.web.pullrequest.iterativereview.discovery.main.desc"),width:370,close:{text:h.default.I18n.getText("bitbucket.web.got.it")},moreInfo:{href:bitbucket_help_url("bitbucket.help.pull.request"),text:h.default.I18n.getText("bitbucket.web.pullrequest.learn.more"),extraAttributes:{target:"_blank"}},once:!0}])}),va=n.default.once(function(){A.default.registerFeature("commit-level-review",[{id:"commit-level-review",alignment:"right top",selector:".file-tree-container .commit-selector-button",
content:bitbucket.internal.feature.pullRequest.commitLevelReviewFeatureDiscoveryContent(),width:300,close:{text:h.default.I18n.getText("bitbucket.web.got.it")},moreInfo:{href:bitbucket_help_url("bitbucket.help.pull.request"),text:h.default.I18n.getText("bitbucket.web.pullrequest.learn.more"),extraAttributes:{target:"_blank"}},once:!0}])});(0,d.default)(document).on("click",".file-tree a",function(a){a={index:this.id.match(/\d+/),keyboard:!(a.originalEvent instanceof MouseEvent)};t.default.trigger("bitbucket.internal.feature.pullRequest.diff.fileChange",
null,a)});w.default={init:function(a){var c=this,g=a.commit,k=a.commitRange,p=a.currentUser,b=a.pullRequest,v=a.maxChanges,w=a.relevantContextLines,x=a.seenCommitReview,E=void 0,q=!1,r=b.getReviewers().findByUser(p)&&b.getReviewers().findByUser(p).getLastReviewedCommit(),u=function(a){return a&&(a.getSinceRevision().getId()!==r||a.getUntilRevision().getId()!==b.getFromRef().getLatestCommit())},A=function(a,f,M){var e=ta({commit:a,commitRange:f,pullRequest:b,lastReviewedCommit:r,unreviewedCommits:E,
includesMerge:M});r&&E&&(D=t.default.chainWith(b.getReviewers().findByUser(p)).on("change:lastReviewedCommit",function(a,e){E=!1;r=e;c.commitSelector.resetDialog();u(f)&&!(0,d.default)(".arbitrary-diff-button").length&&N(f);H()}));var g=r!==b.getFromRef().getLatestCommit();c.commitSelector.resetDialog();c.commitSelector.init({commitRange:f,updateButton:!0,selectedCommit:a,selectedItem:n.default.find(e,"selected"),itemTemplate:function(a){return bitbucket.internal.feature.fileContent.commitSelectorItemMessage(babelHelpers.extends({},
a,{beforeContent:g&&a.commit.id===r?bitbucket.internal.feature.pullRequest.lastReviewedMarker():null}))},itemExtraClasses:function(a){return g&&a.hasOwnProperty("id")&&a.id===r?["last-reviewed-commit"]:a.commitRange?["unreviewed-commits-item"]:[]},itemUrl:function(a){return m(b).commit(a.id).build()},lastPageMessage:h.default.I18n.getText("bitbucket.web.pullrequest.diff.no.more.commits"),mode:na.default.DIFF,path:new oa.default(decodeURI(window.location.hash.substring(1))),preloadItems:e,pullRequest:b,
includesMerge:M})},z=function(a,f){var e=a?new B.default({pullRequest:b,sinceRevision:a.parents?new J.default(a.parents[0]):void 0,untilRevision:new J.default(a),diffType:K}):f?new B.default({pullRequest:b,sinceRevision:f.getSinceRevision(),untilRevision:f.getUntilRevision()}):new B.default({pullRequest:b,diffType:F});(0,d.default)('.menu-item[data-module-key\x3d"bitbucket.pull-request.nav.diff"] \x3e a').attr("href",location.href);H();a?t.default.trigger("bitbucket.internal.feature.pullRequest.commitDiff.view",
null,{commitJSON:a}):f?t.default.trigger("bitbucket.internal.feature.pullRequest.iterativeDiff.view",null,{commitRangeJSON:f.toJSON()}):t.default.trigger("bitbucket.internal.feature.pullRequest.effectiveDiff.view",null,{});y.default.reset();y.default.init(e,ua(a,f,b,v,w));u(f)?N(f):A(a,f,q);x||va()},N=function(a){var f=(0,d.default)(bitbucket.internal.feature.pullRequest.arbitraryDiffButton({sinceCommit:a.getSinceRevision().getId(),untilCommit:a.getUntilRevision().getId()})),e=(0,d.default)(".file-tree-container .commit-selector-button");
e.after(f);e.hide();f.children(".close-dialog").on("click",function(){f.remove();e.show();C.default.pushState({},null,m(b).unreviewed().build())})},P=function(){var a=(0,d.default)(".file-tree-container .commit-selector-button"),f=(0,d.default)(".file-tree-header");a.hide();f.hide();var c=(0,d.default)(".file-tree-wrapper");c.spin("large",{zIndex:10,top:0});var h=function(){c&&c.spinStop();c=null};l.push({destroy:h});G=la.default.getUnreviewedChangesRequest({pullRequest:b.toJSON(),start:0,limit:v}).done(function(e){h();
a.show();f.show();var c=void 0;e.properties&&(e.properties.unreviewedCommits&&(E=e.properties.unreviewedCommits,c={sinceRevision:{id:e.fromHash},untilRevision:{id:e.toHash}}),q=e.properties.includesMerge);n.default.startsWith(location.pathname,m(b).unreviewed().build())?O({action:C.default.replaceState,commitRangeJSON:q?null:c,pullRequest:b}):z(g,k)})},O=function(a){var f=a.action,c=a.commitJSON,e=a.commitRangeJSON,b=a.pullRequest;f=f||C.default.pushState;a=encodeURI(y.default.getSelectedPath()||
"");c?(e=m(b).commit(c.id),f({commit:c},null,e.withFragment(a).build())):e?f({commitRange:e},null,L({pullRequest:b,commit:e.untilRevision.id,since:e.sinceRevision.id}).withFragment(a).build()):f({},null,m(b).diff().withFragment(a).build())},Q=function(a){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,b=c.commitSelector.getSelectedCommit();if(b){var d=n.default.get(b,"properties",{});e=n.default.get(d,"commentCount",e);d={properties:babelHelpers.extends({},d,{commentCount:e+a})};c.commitSelector.refreshCommit(b.id,
d)}};l.push(t.default.chain().on("bitbucket.internal.feature.commitselector.itemSelected",O).on("bitbucket.internal.history.changestate",function(a){n.default.startsWith(location.pathname,m(b).unreviewed().build())?P():a.state&&z(a.state.commit,a.state.commitRange&&new B.default(a.state.commitRange))}).on("bitbucket.internal.keyboard.shortcuts.pullrequest.addCommentHandler",function(a){(this.execute?this:h.default.whenIType(a)).execute(function(){(0,d.default)(".add-file-comment-trigger:first").click()})}).on("bitbucket.internal.feature.comments.commentAdded",
function(){return Q(1)}).on("bitbucket.internal.feature.comments.commentDeleted",function(){return Q(-1,1)}));this.commitSelector=new ka.default({buttonEl:".file-tree-container .commit-selector-button",id:"commit-selector"});I.default.init();l.push(this.commitSelector);l.push({destroy:function(){return I.default.reset()}});l.push({destroy:function(){return y.default.reset()}});l.push({destroy:ma.default.acceptScrollForwardingRequests()});C.default.initialState({commit:g,commitRange:k&&k.toJSON()});
P()},reset:function(){G&&G.abort();H();var a=d.default.when.apply(d.default,babelHelpers.toConsumableArray(n.default.invokeMap(l,"destroy")));l=[];return a}};R.exports=w["default"]});