define("bitbucket/internal/feature/permission/permission-table/permission-table","module exports @atlassian/aui jquery lodash bitbucket/internal/feature/permission/multi-selector/multi-selector bitbucket/internal/model/page-state bitbucket/internal/util/ajax bitbucket/internal/util/function bitbucket/internal/util/warn-before-unload".split(" "),function(u,q,e,v,w,x,y,z,A,B){function C(a,b){return{getMembers:function(c){return l.default.rest({url:a[b+"s"]().build(),type:"GET",data:c})},getNonMembers:function(c){return l.default.rest({url:a[b+
"s"]().none().build(),type:"GET",data:c})},setPermission:function(c,d){return l.default.rest({url:a[b+"s"]().withParams({permission:c,name:d}).build(),type:"PUT",statusCode:{400:!1,403:!1,404:!1,409:!1}})},removePermissions:function(c){return l.default.rest({url:a[b+"s"]().withParams({name:c}).build(),type:"DELETE",statusCode:{400:!1,403:!1,404:!1,409:!1}})}}}function m(a){this._delegate=a;this._pageReceived=h.default.bind(this._pageReceived,this);this.clear()}function f(a,b,c,d,g,e){this._entityType=
d;"user"===this._entityType?(this._text=f.userText,this._rowTemplate=bitbucket.internal.feature.permission.userPermissionRow,this._isEntityCurrentUser=function(a){return n.default.getCurrentUser()&&a.name===n.default.getCurrentUser().getName()}):(this._text=f.groupText,this._rowTemplate=bitbucket.internal.feature.permission.groupPermissionRow,this._isEntityCurrentUser=r.default.constant(!1));this._dataSource=C(b,this._entityType);this._permissions=h.default.map(c,"name");this._initialPermission=this._permissions[this._permissions.length-
1];this._permissionNames=h.default.map(c,"i18nName");this._currentUserHighestPerm=g;this._pageSize=50;this._addedEntities=[];this.opts=e||{};this._wireComponents(a);this._initHelpDialogs();this._initAddMultiSelector();this._initRows();this._initLoadMoreButton();this.refresh()}Object.defineProperty(q,"__esModule",{value:!0});var k=babelHelpers.interopRequireDefault(v),h=babelHelpers.interopRequireDefault(w),E=babelHelpers.interopRequireDefault(x),n=babelHelpers.interopRequireDefault(y),l=babelHelpers.interopRequireDefault(z),
r=babelHelpers.interopRequireDefault(A),t=babelHelpers.interopRequireDefault(B);m.prototype.clear=function(){this._nextPageStart=0};m.prototype.nextPage=function(a){return this._delegate.getNonMembers({start:this._nextPageStart,filter:a,avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"xsmall"})}).done(this._pageReceived)};m.prototype._pageReceived=function(a){this._nextPageStart=a.nextPageStart||a.start+a.size};f.text={entityList:{buttonLoadMoreText:e.I18n.getText("bitbucket.web.permission.table.load.more"),
deletedUser:e.I18n.getText("bitbucket.web.permission.table.deleted.user.tooltip")},pendingModification:e.I18n.getText("bitbucket.web.pending.request",bitbucket.internal.util.productName()),cantGrantHigherPerms:function(a){return e.I18n.getText("bitbucket.web.permission.table.cantgranthigher.tooltip",a)},inheritedPerm:e.I18n.getText("bitbucket.web.permission.table.inheritedperm.tooltip")};f.userText=k.default.extend(!0,{inactiveEntity:function(a){return e.I18n.getText("bitbucket.web.permission.table.inactive.user",
a)},cantRevokeHigherPerms:function(a){return e.I18n.getText("bitbucket.web.permission.table.cantrevokehigheruser.tooltip",a)},cantGrantSelfHigherPerms:function(a){return e.I18n.getText("bitbucket.web.permission.table.cantgrantselfhigher.tooltip",a)},implicitPerm:e.I18n.getText("bitbucket.web.permission.table.basePerm.user.tooltip"),noMoreItemsText:e.I18n.getText("bitbucket.web.permission.table.users.none.added")},f.text);f.groupText=k.default.extend(!0,{inactiveEntity:function(a){return e.I18n.getText("bitbucket.web.permission.table.invisible.group",
a)},cantRevokeHigherPerms:function(a){return e.I18n.getText("bitbucket.web.permission.table.cantrevokehighergroup.tooltip",a)},implicitPerm:e.I18n.getText("bitbucket.web.permission.table.basePerm.group.tooltip"),noMoreItemsText:e.I18n.getText("bitbucket.web.permission.table.groups.none.added")},f.text);f.prototype._wireComponents=function(a){this._$container=(0,k.default)(a);this._$tbody=this._$container.find("tbody");this._$noResults=this._$container.find(".no-results-row");this._$loadMore=this._$container.find(".load-more");
this._$spinner=(0,k.default)(this._$loadMore).parent().append('\x3cdiv class\x3d"permissions-spinner" /\x3e').find(".permissions-spinner")};f.prototype._getModalItem=function(a){return{content:(0,k.default)(bitbucket.internal.feature.permission.permissionModalItem({entity:a,isUser:"user"===this._entityType,inactiveText:this._text.inactiveEntity(a.name)})),id:a.name}};f.prototype._initAddMultiSelector=function(){var a=this;this._multiSelector=new E.default({el:this._$container.find(".permission-multi-selector-container")[0],
entityType:this._entityType,add:function(b){return a._dataSource.setPermission(b.permission,h.default.map(b.entities,"name")).done(function(){a._addedEntities.push.apply(a._addedEntities,h.default.map(b.entities,function(c){var d={permission:b.permission};d[a._entityType]=c;return d}));(0,e.flag)({type:"success",close:"auto",body:bitbucket.internal.feature.permission.flag.added({name:b.entities[0].name,entityType:a._entityType,count:b.entities.length})});a.refresh()})},dataSource:new m(this._dataSource)})};
f.prototype._updateErrors=function(a,b){var c=a.closest("tr"),d=c.attr("data-entity-id");c.closest("tbody").find(".permission-error").remove();return b.fail(function(a,b,f,e){if(e&&e.errors){var g=c.children("td").length;k.default.each(e.errors,function(a){c.after(bitbucket.internal.feature.permission.errorPermissionRow({entityId:d,numRows:g,message:e.errors[a].message}))})}})};f.prototype._spinWhilePending=function(a,b){if(b&&"pending"===b.state()){a.closest("tr").find(":checkbox").prop("disabled",
!0);var c=(0,k.default)('\x3cdiv class\x3d"spinner" /\x3e');c.insertAfter(a);a.addClass("hidden");c.spin("small");b.always(function(){a.removeClass("hidden");c.spinStop().remove()})}};f.prototype._getAllCheckboxes=function(a){return a.parent().parent().find(":checkbox")};f.prototype._getCheckboxStates=function(a){return k.default.map(a,function(a){return{checked:(0,k.default)(a).prop("checked"),disabled:(0,k.default)(a).prop("disabled")}})};f.prototype._restoreCheckboxStates=function(a,b){k.default.each(b,
function(b,d){(0,k.default)(a.get(b)).prop("checked",d.checked).prop("disabled",d.disabled).toggleClass("disabled",d.disabled)})};f.prototype._setChecked=function(a,b,c){this._restoreCheckboxStates(this._getAllCheckboxes(a),c);b.prop("checked",!1).prop("title","");b=a.parent().nextAll().children(":checkbox").prop("checked",!0).prop("disabled",!0).addClass("disabled").prop("title",this._text.inheritedPerm);a.prop("title",b.length?"":this._text.implicitPerm);a.prop("checked",!0).prop("disabled",!b.length).toggleClass("disabled",
!b.length);var d=a.closest("[data-entity-id]").attr("data-entity-id"),g=this._entityType;h.default.forEach(this._addedEntities,function(b){b[g].name===d&&(b.permission=a.val())})};f.prototype._initHelpDialogs=function(){var a=this._$container.find("th.permission-column \x3e .aui-icon.aui-iconfont-question-circle"),b=new e.InlineDialog(a,(0,e.id)("help-dialog"),function(a,d,g){a.empty().append((0,k.default)(d).parent().find(".permission-column-desc").clone());g();b.refresh()},{offsetX:-100,onHover:!0,
gravity:"s"})};f.prototype._initRows=function(){var a=this;this._$tbody.on("change",":checkbox",function(){var b=(0,k.default)(this),c=b.parent(),d=c.next();c=c.parent().attr("data-entity-id");if(this.checked){for(;d.length&&!d.children(":checked").length;)d=d.next();var g=d.children(":checkbox");var e=b;g.prop("value");d=this.value}else g=b,e=d.children(":checkbox"),d=e.prop("value");var f=[];d&&f.push(a._dataSource.setPermission(d,c));var h=a._getCheckboxStates(a._getAllCheckboxes(e));c=k.default.when.apply(k.default,
f);a._spinWhilePending(b,c);a._updateErrors(b,c);c.done(function(){a._setChecked(e,g,h)}).fail(function(b,c,d,f){a._setChecked(g,e,h)});(0,t.default)(c,a._text.pendingModification)}).on("click",".delete-button",function(b){var c=(0,k.default)(this),d=c.parents("tr").first(),g=d.attr("data-entity-id"),f=d.find(":checkbox"),D=a._getCheckboxStates(f),p=a._dataSource.removePermissions(g);a._spinWhilePending(c,p);a._updateErrors(c,p);p.done(function(){a._numLoaded--;a._addedEntities=h.default.filter(a._addedEntities,
function(b){var c=b[a._entityType].name===g;c&&!b.loaded&&a._numLoaded++;return!c});if(!d.siblings().length&&!a._$loadMore.is(":visible")){var b=a._$noResults.find("div");b.css("opacity",0);a._$noResults.show();b.animate({opacity:1},500)}(0,e.flag)({type:"success",close:"auto",body:bitbucket.internal.feature.permission.flag.deleted({name:g,entityType:a._entityType})});d.remove()}).fail(function(){a._restoreCheckboxStates(f,D)});(0,t.default)(p,a._text.pendingModification);b.preventDefault();return!1})};
f.prototype._initLoadMoreButton=function(a){var b=this;this._$loadMore.click(function(a){b._loadItems();a.preventDefault()})};f.prototype._renderRow=function(a,b,c,d){var g=this,e=h.default.isUndefined(b)?g._permissions.length-1:h.default.indexOf(this._permissions,b),f=h.default.indexOf(this._permissions,c),k=e<f;c=g._permissionNames[e];return this._rowTemplate({entity:a,entityPermissions:h.default.map(this._permissions,function(c,d,e){var l=g._permissionNames[d],m=c===b,n=d<f,p=h.default.some(e.slice(0,
d),r.default.eq(b));return{name:c,granted:m,inherited:p,privileged:n,tooltip:function(){if(!k){if(n&&!m)return g._isEntityCurrentUser(a)?g._text.cantGrantSelfHigherPerms(l):g._text.cantGrantHigherPerms(l);if(p)return g._text.inheritedPerm;if(d===g._permissions.length-1)return g._text.implicitPerm}return""}()}}),tooltip:k?g._text.cantRevokeHigherPerms(c):"",showRemovePermsButton:d||e>=f,linkToEntities:n.default.getCurrentUser()&&n.default.getCurrentUser().getIsAdmin()})};f.prototype._loadItems=function(){var a=
this;this._$spinner.spin("small");this._numLoaded||(a._$tbody.empty(),a._$noResults.hide());!this._numLoaded&&this._addedEntities.length&&a._$tbody.append(h.default.chain(this._addedEntities).sortBy(function(b){return b[a._entityType].name}).reduce(function(b,c){return b+a._renderRow(c[a._entityType],c.permission,a._currentUserHighestPerm,!0)},"").value());a._dataSource.getMembers({start:a._numLoaded,limit:a._pageSize,avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"xsmall"})}).done(function(b){a.opts.preProcessMembers&&
(b=a.opts.preProcessMembers(b,a._entityType));a._$spinner.spinStop();a._$loadMore.toggleClass("hidden disabled",b.isLastPage);b.values.length?a._$noResults.hide():b.start||a._addedEntities.length||a._$noResults.show();a._numLoaded+=b.values.length;var c=h.default.chain(a._addedEntities).map(a._entityType).map("name").invokeMap("toLowerCase").value();b=h.default.filter(b.values,function(b){b=k.default.inArray(b[a._entityType].name.toLowerCase(),c);-1!==b&&(a._addedEntities[b].loaded=!0);return-1===
b});b.length&&a._$tbody.append(h.default.reduce(b,function(b,c){return b+a._renderRow(c[a._entityType],c.permission,a._currentUserHighestPerm)},""));a._$tbody.find(".deleted-user .display-name").tooltip({title:function(){return a._text.entityList.deletedUser},gravity:"w"});a._$noResults.find("div").show()})};f.prototype.refresh=function(a){a&&(this._addedEntities=[]);this._numLoaded=0;h.default.forEach(this._addedEntities,function(a){a.loaded=!1});this._loadItems()};q.default={initialise:function(a,
b,c,d){return h.default.map(["user","group"],function(e){return new f("#"+e+"-permissions-table",a,b,e,c,d)})}};u.exports=q["default"]});