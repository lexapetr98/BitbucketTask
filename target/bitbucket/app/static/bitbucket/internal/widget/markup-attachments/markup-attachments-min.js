define("bitbucket/internal/widget/markup-attachments/markup-attachments","module exports @atlassian/aui jquery lodash bitbucket/util/navbuilder bitbucket/internal/model/page-state bitbucket/internal/util/events bitbucket/internal/util/feature-enabled bitbucket/internal/util/function bitbucket/internal/util/promise bitbucket/internal/util/property bitbucket/internal/util/text bitbucket/internal/widget/drag-drop-file-uploader/drag-drop-file-uploader bitbucket/internal/widget/inline-error-dialog/inline-error-dialog".split(" "),
function(r,f,g,t,u,v,w,x,y,h,z,A,B,C,D){function c(a){if(!c.isSupported())throw Error("MarkupAttachments requires DragDropFileUploader support");this.init.apply(this,arguments)}function E(a,b,c){var e=a.links.attachment;a=e&&e.href||a.links.self.href;b=(b||"").replace(/[^\w\.\-]/g,"");b=0===b.length||"."===d.default.head(b)?"upload"+b:b;a=a.replace(/([\(\)])/g,"\\$1");return"["+(k.default.typeFilters.image.test(c)?"!["+b+"]("+a+")":b)+"]("+a+")"}function F(a){return a+(a.length&&"\n"!==d.default.last(a)?
"\n":"")}Object.defineProperty(f,"__esModule",{value:!0});var l=babelHelpers.interopRequireDefault(g),m=babelHelpers.interopRequireDefault(t),d=babelHelpers.interopRequireDefault(u),G=babelHelpers.interopRequireDefault(v),H=babelHelpers.interopRequireDefault(w),n=babelHelpers.interopRequireDefault(x);g=babelHelpers.interopRequireDefault(y);var e=babelHelpers.interopRequireDefault(h),I=babelHelpers.interopRequireDefault(z);h=babelHelpers.interopRequireDefault(A);var J=babelHelpers.interopRequireDefault(B),
k=babelHelpers.interopRequireDefault(C),K=babelHelpers.interopRequireDefault(D),p;g.default.getFromProvider("attachments").done(function(a){p=a});var q;h.default.getFromProvider("attachment.upload.max.size").done(function(a){q=a});c.isEnabled=function(){return p};c.isSupported=k.default.isSupported;c._editorClass="markup-attachments";c.prototype.init=function(a){this.$editor=(0,m.default)(a);this.$textarea=this.$editor.find("textarea");this.$uploadButton=this.$editor.find(".markup-attachments-button");
this._destroyables=[];d.default.bindAll(this,"handleUpload","handleAttachment","handleFailures","hideErrors");this.$editor.addClass(c._editorClass);this.dragDropFileUploader=new k.default(this.$editor,{url:L,fieldName:"files",uploadButton:this.$uploadButton,fileSizeLimit:q});this._destroyables.push(this.dragDropFileUploader);this._destroyables.push(n.default.chainWith(this.dragDropFileUploader).on({filesSelected:this.hideErrors,invalidFiles:e.default.partialRight(d.default.forEach,e.default.binary(this.handleFailures)),
uploadStarted:this.handleUpload}));a=J.default.formatSizeInBytes(this.dragDropFileUploader.options.fileSizeLimit);this.errorDialog=new K.default(this.$uploadButton,{title:function(a){return l.default.I18n.getText("bitbucket.web.markup.attachments.error.title",a.length)},subtitle:l.default.I18n.getText("bitbucket.web.markup.attachments.error.subtitle",a)});this._destroyables.push(this.errorDialog);this._destroyables.push(n.default.chainWith(this.$editor).on("resize",this.errorDialog.refresh));a=(0,
m.default)(aui.icons.icon({icon:"success",useIconFont:!0})).appendTo(this.$uploadButton);this._destroyables.push({destroy:a.remove.bind(a)});this.rollingSpinner=I.default.rollingSpinner(this.$uploadButton)};c.prototype.handleUpload=function(a,b){this.rollingSpinner.add(a);var c=d.default.flow(e.default.dot("attachments"),e.default.partialRight(d.default.forEach,d.default.partial(this.handleAttachment,b)));a.done(c).fail(function(a,c){this.handleFailures([b],c,{statusCode:a.status})}.bind(this))};
c.prototype.handleAttachment=function(a,b){b.errors?(b=d.default.head(b.errors),this.handleFailures([a],b.exceptionName,{message:b.message})):this.$textarea.val(F(this.$textarea.val())+E(b,a.name,a.type)).trigger("input").focus()};c.prototype.handleFailures=function(a,b,c){"abort"===b||"error"===b&&500!==c.statusCode?this.hideErrors():(d.default.map(a,"name").forEach(this.errorDialog.add),this.errorDialog.show())};c.prototype.hideErrors=function(){this.errorDialog.hide()};c.prototype.destroy=function(){this.$editor.removeClass(c._editorClass);
d.default.invokeMap(this._destroyables,"destroy")};var L=function(){return H.default.getRepository()&&G.default.currentRepo().attachments().build()};f.default=c;r.exports=f["default"]});