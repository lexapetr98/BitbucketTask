define("bitbucket/internal/widget/image-upload-and-crop/image-upload-and-crop","module exports @atlassian/aui jquery lodash bitbucket/internal/util/text bitbucket/internal/widget/canvas-cropper/canvas-cropper bitbucket/internal/widget/client-file-handlers/client-file-reader bitbucket/internal/widget/drag-drop-file-target/drag-drop-file-target bitbucket/internal/widget/faux-upload-field/faux-upload-field bitbucket/internal/widget/image-explorer/image-explorer bitbucket/internal/widget/paste-image-target/paste-image-target bitbucket/internal/widget/webcam-capture/webcam-capture".split(" "),
function(n,h,p,q,r,t,u,v,w,x,y,z,A){function b(a,b){this.init.apply(this,arguments)}Object.defineProperty(h,"__esModule",{value:!0});var c=babelHelpers.interopRequireDefault(p),e=babelHelpers.interopRequireDefault(q),f=babelHelpers.interopRequireDefault(r),k=babelHelpers.interopRequireDefault(t),B=babelHelpers.interopRequireDefault(u),g=babelHelpers.interopRequireDefault(v),C=babelHelpers.interopRequireDefault(w),D=babelHelpers.interopRequireDefault(x),l=babelHelpers.interopRequireDefault(y),E=babelHelpers.interopRequireDefault(z),
m=babelHelpers.interopRequireDefault(A);b.maskShapes=l.default.maskShapes;b.prototype.defaults={HiDPIMultiplier:2,dragDropUploadPrompt:c.default.I18n.getText("bitbucket.web.drag.drop.image.prompt"),onImageUpload:e.default.noop,onImageUploadError:e.default.noop,onImageClear:e.default.noop,onCrop:e.default.noop,outputFormat:"image/png",fallbackUploadOptions:{},initialScaleMode:l.default.scaleModes.containAndFill,scaleMax:1,fileSizeLimit:5242880,maxImageDimension:2E3,pasteUpload:!0};b.prototype.init=
function(a,b){this.options=e.default.extend({},this.defaults,b);this.$container=a;f.default.bindAll(this,"crop","resetState","_onFileProcessed","setImageSrc","validateImageResolution","_onFilesError","_onFileError","_resetFileUploadField","_onErrorReset");this.imageExplorer=new l.default(this.$container.find(".image-explorer-container"),{initialScaleMode:this.options.initialScaleMode,scaleMax:this.options.scaleMax,onErrorReset:this._onErrorReset});g.default.isSupported()&&(this.clientFileReader=new g.default({onRead:this._onFileProcessed,
onError:this._onFilesError,fileTypeFilter:g.default.typeFilters.imageWeb,fileCountLimit:1,fileSizeLimit:this.options.fileSizeLimit}),this.dragDropFileTarget=new C.default(this.imageExplorer.get$ImageView(),{uploadPrompt:this.options.dragDropUploadPrompt,clientFileHandler:this.clientFileReader}),this.options.pasteUpload&&(this.pasteImageTarget=new E.default(this.imageExplorer.get$ImageView(),this.clientFileReader)));this.fauxUploadField=new D.default(this.$container.find(".image-select-button"),{clientFileHandler:this.clientFileReader,
accept:g.default.typeFilters.imageWeb});a=this.imageExplorer.get$Mask();this.canvasCroppper=new B.default(a.width()*this.options.HiDPIMultiplier,a.height()*this.options.HiDPIMultiplier,{outputFormat:this.options.outputFormat});this.options.cropButton&&(0,e.default)(this.options.cropButton).click(this.crop);this.$container.find(".webcam-capture").length&&(m.default.isSupported()?this.webcamCapture=this.initWebcamUpload():this.$container.find(".use-webcam").prop("disabled",!0).attr("title",c.default.I18n.getText("bitbucket.web.webcam.browser.unsupported")))};
b.prototype.initWebcamUpload=function(){var a=this,b=this.$container.find(".use-webcam"),d=new m.default(this.$container.find(".webcam-capture"),{countdown:!0,mirror:!0,width:640,onCapture:function(b){d.pause();a.setImageSrc(b);a.$container.removeClass("webcam-mode");a.$container.find(".retake-photo").removeClass("hidden").focus()}});b.on("click",function(){a.$container.addClass("webcam-mode");a.setImageSrc("");d.start()});return d};b.prototype._resetWebcamUpload=function(){this.webcamCapture&&(this.webcamCapture.stop(),
this.$container.removeClass("webcam-mode"),this.$container.find(".retake-photo").addClass("hidden"))};b.prototype.crop=function(){var a=this.imageExplorer.getMaskedImageProperties();a=this.canvasCroppper.cropToDataURI(this.imageExplorer.get$SourceImage()[0],a.maskedAreaImageX,a.maskedAreaImageY,a.maskedAreaWidth,a.maskedAreaHeight);f.default.isFunction(this.options.onCrop)&&this.options.onCrop(a)};b.prototype.resetState=function(){this.imageExplorer.clearError();this._resetFileUploadField();this._resetWebcamUpload();
this.setImageSrc("")};b.prototype._onFileProcessed=function(a){a?isNaN(this.options.maxImageDimension)?this.setImageSrc(a):this.validateImageResolution(a).done(f.default.bind(function(b,d){this.setImageSrc(a)},this)).fail(f.default.bind(function(a,b){this._onFileError(c.default.I18n.getText("bitbucket.web.avatar.error.file.resolution",a,b,this.options.maxImageDimension))},this)):this._onFileError()};b.prototype.setImageSrc=function(a){this.$container.find(".input-buttons").toggleClass("hidden",!!a);
this.imageExplorer.setImageSrc(a);if(a)this.options.onImageUpload(a);else this.options.onImageClear();this._resetFileUploadField()};b.prototype.validateImageResolution=function(a){var b=e.default.Deferred(),d=new Image,c=this;d.onload=function(){this.naturalWidth>c.options.maxImageDimension||this.naturalHeight>c.options.maxImageDimension?b.reject(this.naturalWidth,this.naturalHeight):b.resolve(this.naturalWidth,this.naturalHeight)};d.src=a;return b};b.prototype._onFilesError=function(a){a&&a.bySize&&
a.bySize.length?(a=f.default.head(a.bySize),this._onFileError(c.default.escapeHtml(c.default.I18n.getText("bitbucket.web.avatar.error.filetoobig",k.default.abbreviateText(a.name,50),k.default.formatSizeInBytes(a.size),k.default.formatSizeInBytes(this.options.fileSizeLimit))))):this._onFileError()};b.prototype._onFileError=function(a){var b=c.default.I18n.getText("bitbucket.web.avatar.error.adding.file.title"),d=a||c.default.I18n.getText("bitbucket.web.avatar.error.adding.file.contents");this.imageExplorer.showError(b,
d);this._resetFileUploadField();f.default.isFunction(this.options.onImageUploadError)&&this.options.onImageUploadError(a)};b.prototype._resetFileUploadField=function(){var a=this.$container.find("#image-upload-and-crop-upload-field").prop("form");a&&a.reset()};b.prototype._onErrorReset=function(a){a&&f.default.isFunction(this.options.onImageUpload)&&this.options.onImageUpload(a)};h.default=b;n.exports=h["default"]});