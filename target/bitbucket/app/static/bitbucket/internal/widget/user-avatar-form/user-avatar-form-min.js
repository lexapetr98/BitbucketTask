define("bitbucket/internal/widget/user-avatar-form/user-avatar-form","module exports @atlassian/aui jquery lodash bitbucket/util/navbuilder bitbucket/internal/util/ajax bitbucket/internal/util/events bitbucket/internal/widget/avatar-picker-dialog/avatar-picker-dialog bitbucket/internal/widget/confirm-dialog/confirm-dialog".split(" "),function(q,g,r,t,u,v,w,x,y,z){function c(a,b,f){k.default.bindAll(this,"restorePreview","save","_onSuccess");this.user=b;this.$container=(0,e.default)(a);this.$delete=
this.$container.find(".avatar-delete-trigger");this.$image=this.$container.find(".user-avatar img");this.$picker=this.$container.find(".avatar-picker-trigger");this.xsrfToken=f;this._initDialogs();this._toggleAvatarSource()}function l(a,b,f){return a.href||201===f.status&&f.getResponseHeader("Location")}function A(a,b){a=h.default.parse(a);k.default.forEach(b,function(b,c){b&&a.replaceQueryParam(c,b)});return a}Object.defineProperty(g,"__esModule",{value:!0});var d=babelHelpers.interopRequireDefault(r),
e=babelHelpers.interopRequireDefault(t),k=babelHelpers.interopRequireDefault(u),h=babelHelpers.interopRequireDefault(v),B=babelHelpers.interopRequireDefault(w),m=babelHelpers.interopRequireDefault(x),n=babelHelpers.interopRequireDefault(y),C=babelHelpers.interopRequireDefault(z),p={statusCode:{400:!1,401:function(a,b,c,e,d){return d.shouldLogin},404:!1,500:!1}};m.default.addLocalEventMixin(c.prototype);c.prototype.refreshAll=function(a){var b=this;(0,e.default)(".aui-avatar").filter(function(){return(0,
e.default)(this).attr("data-username")===b.user.name}).find(".aui-avatar-inner \x3e img").each(function(){var b=(0,e.default)(this).attr("src");b=h.default.parse(b).getQueryParamValue("s");(0,e.default)(this).attr("src",A(a,{s:b,t:(new Date).getTime()}))})};c.prototype.restorePreview=function(){this.updatePreview(this.oldImage)};c.prototype.save=function(a){this.updatePreview(a);this.upload(a)};c.prototype.updatePreview=function(a){this.oldImage=this.$image.attr("src");this.$image.attr("src",a)};
c.prototype.upload=function(a){var b=this.$image.parent();b.spin("large",{color:"#fff"});this.$picker.prop("disabled",!0);B.default.ajax(e.default.extend({url:this._getUploadUrl(),data:{avatar:a},type:"POST"},p)).then(l).done(this._onSuccess).fail(this.trigger.bind(this,"avatarUploadError",d.default.I18n.getText("bitbucket.web.user.avatar.upload.error"))).fail(this.restorePreview).always(b.spinStop.bind(b)).always(this.$picker.prop.bind(this.$picker,"disabled",!1))};c.prototype._initDialogs=function(){this.pickerDialog=
new n.default({dialogTitle:d.default.I18n.getText("bitbucket.web.user.avatar.upload.title"),dialogDoneButtonText:d.default.I18n.getText("bitbucket.web.button.save"),maskShape:n.default.maskShapes.CIRCLE,trigger:this.$picker,onCrop:this.save,xsrfToken:this.xsrfToken,enableWebcam:!0});this.deleteDialog=new C.default({id:"delete-avatar-dialog",titleClass:"warning-header",titleText:d.default.I18n.getText("bitbucket.web.user.avatar.delete.title"),panelContent:bitbucket.internal.widget.paragraph({text:d.default.I18n.getText("bitbucket.web.user.avatar.delete.confirm")}),
submitText:d.default.I18n.getText("bitbucket.web.button.remove"),focusSelector:".cancel-button"},e.default.extend({type:"DELETE"},p));var a=this;this.deleteDialog.addConfirmListener(function(b){b.then(l).done(a._onSuccess).fail(a.trigger.bind(a,"avatarDeleteError",d.default.I18n.getText("bitbucket.web.user.avatar.delete.error")))});this.deleteDialog.attachTo(null,null,this.$delete)};c.prototype._getUploadUrl=function(){var a=h.default.user(this.user.slug).avatar();if(this.xsrfToken){var b={};b[this.xsrfToken.name]=
this.xsrfToken.value;return a.withParams(b).build()}return a.build()};c.prototype._onSuccess=function(a){this.refreshAll(a);this._toggleAvatarSource();this.trigger("avatarChanged",this.user);m.default.trigger("bitbucket.internal.widget.userAvatarForm.avatarChanged",null,this.user)};c.prototype._toggleAvatarSource=function(){var a=/^https?:\/\/(www|secure)\.gravatar.com\/.+/g.test(this.$image.attr("src"));this.$container.toggleClass("gravatar-source",a)};g.default=c;q.exports=g["default"]});